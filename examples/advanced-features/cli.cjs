#!/usr/bin/env node
/**
 * Nested Command Demo - Demonstration of deep nested command capabilities
 * Generated by Goobits CLI Framework
 */

const { Command } = require('commander');
// Hook loading with enhanced error handling
let hooks = null;
try {
    hooks = require('./hooks.cjs');
} catch (error) {
    if (error.code === 'MODULE_NOT_FOUND') {
        console.error('Hook implementation not found. Please create \'src/hooks.js\' with your command implementations.');
        console.error('See documentation for hook function signatures.');
    } else {
        console.error(`Failed to load hooks: ${error.message}`);
    }
    process.exit(2);
}
// Enhanced error handling for Node.js
class CLIError extends Error {
    constructor(message, code = 1, details = null) {
        super(message);
        this.name = 'CLIError';
        this.code = code;
        this.details = details;
    }
}

// Global error handler
function handleError(error, context = 'Command execution', verbose = false) {
    if (error instanceof CLIError) {
        console.error(`${context} failed: ${error.message}`);
        if (verbose && error.details) {
            console.error('Details:', error.details);
        }
        process.exit(error.code);
    } else if (error.code === 'MODULE_NOT_FOUND' && error.message.includes('hooks')) {
        console.error('Hook implementation not found.');
        console.error('Please implement the required hook function in src/hooks.js');
        process.exit(2);
    } else {
        console.error(`${context} failed: ${error.message}`);
        if (verbose && error.stack) {
            console.error('Stack trace:', error.stack);
        }
        process.exit(1);
    }
}

const program = new Command();

program
    .name('')
    .description('None')
    .version('1.0.0')
    .option('-v, --verbose', 'Enable verbose error output and debugging information', false);
// Command hierarchy building for unlimited nesting
const commandMap = new Map();// Level 1: simple
const simpleCmd = program
    .command('simple')
    .description('Simple command that works today');
simpleCmd.argument('message', 'No description');
simpleCmd.option('--verbose', 'Verbose output');
simpleCmd.action(async (message, options) => {
    const globalOpts = program.opts();
    const verbose = globalOpts.verbose || false;
    
    try {
        const hookName = 'on_simple';
        
        if (!hooks) {
            throw new CLIError('Hook module not loaded', 2);
        }
        
        if (typeof hooks[hookName] !== 'function') {
            const availableHooks = Object.keys(hooks).filter(key => typeof hooks[key] === 'function');
            const message = `Hook function '${hookName}' not implemented in src/hooks.js`;
            const details = availableHooks.length > 0 
                ? `Available hooks: ${availableHooks.join(', ')}`
                : 'No hook functions found in src/hooks.js';
            throw new CLIError(message, 2, details);
        }
        
        // Execute the hook function with proper error handling
        const args = [message];
        const result = await hooks[hookName](...args, options);
        
        // Handle return codes
        if (typeof result === 'number' && result !== 0) {
            throw new CLIError(`Command 'simple' failed with exit code ${result}`, result);
        }
        
    } catch (error) {
        if (error.code === 'SIGINT' || error.message.includes('interrupted')) {
            console.error('\\nCommand interrupted by user');
            process.exit(130);
        }
        
        handleError(error, 'Command execution', verbose);
    }
});
commandMap.set('simple', simpleCmd);

// Level 1: database
const databaseCmd = program
    .command('database')
    .description('Database operations');
commandMap.set('database', databaseCmd);


// Level 2: database users
const database_usersCmd = commandMap.get('database')
    .command('users')
    .description('User management');
database_usersCmd.argument('action', 'No description');
database_usersCmd.option('--format', 'Output format', 'table');
database_usersCmd.action(async (action, options) => {
    const globalOpts = program.opts();
    const verbose = globalOpts.verbose || false;
    
    try {
        const hookName = 'on_database_users';
        
        if (!hooks) {
            throw new CLIError('Hook module not loaded', 2);
        }
        
        if (typeof hooks[hookName] !== 'function') {
            const availableHooks = Object.keys(hooks).filter(key => typeof hooks[key] === 'function');
            const message = `Hook function '${hookName}' not implemented in src/hooks.js`;
            const details = availableHooks.length > 0 
                ? `Available hooks: ${availableHooks.join(', ')}`
                : 'No hook functions found in src/hooks.js';
            throw new CLIError(message, 2, details);
        }
        
        // Execute the hook function with proper error handling
        const args = [action];
        const result = await hooks[hookName](...args, options);
        
        // Handle return codes
        if (typeof result === 'number' && result !== 0) {
            throw new CLIError(`Command 'database users' failed with exit code ${result}`, result);
        }
        
    } catch (error) {
        if (error.code === 'SIGINT' || error.message.includes('interrupted')) {
            console.error('\\nCommand interrupted by user');
            process.exit(130);
        }
        
        handleError(error, 'Command execution', verbose);
    }
});
commandMap.set('database/users', database_usersCmd);


// Level 2: database backup
const database_backupCmd = commandMap.get('database')
    .command('backup')
    .description('Database backup operations');
database_backupCmd.option('--compress', 'Compress backup file');
database_backupCmd.action(async (options) => {
    const globalOpts = program.opts();
    const verbose = globalOpts.verbose || false;
    
    try {
        const hookName = 'on_database_backup';
        
        if (!hooks) {
            throw new CLIError('Hook module not loaded', 2);
        }
        
        if (typeof hooks[hookName] !== 'function') {
            const availableHooks = Object.keys(hooks).filter(key => typeof hooks[key] === 'function');
            const message = `Hook function '${hookName}' not implemented in src/hooks.js`;
            const details = availableHooks.length > 0 
                ? `Available hooks: ${availableHooks.join(', ')}`
                : 'No hook functions found in src/hooks.js';
            throw new CLIError(message, 2, details);
        }
        
        // Execute the hook function with proper error handling
        const args = [];
        const result = await hooks[hookName](...argsoptions);
        
        // Handle return codes
        if (typeof result === 'number' && result !== 0) {
            throw new CLIError(`Command 'database backup' failed with exit code ${result}`, result);
        }
        
    } catch (error) {
        if (error.code === 'SIGINT' || error.message.includes('interrupted')) {
            console.error('\\nCommand interrupted by user');
            process.exit(130);
        }
        
        handleError(error, 'Command execution', verbose);
    }
});
commandMap.set('database/backup', database_backupCmd);

// Level 1: api
const apiCmd = program
    .command('api')
    .description('API management');
commandMap.set('api', apiCmd);


// Level 2: api v1
const api_v1Cmd = commandMap.get('api')
    .command('v1')
    .description('API v1 endpoints');
commandMap.set('api/v1', api_v1Cmd);


// Level 3: api v1 users
const api_v1_usersCmd = commandMap.get('api/v1')
    .command('users')
    .description('User API endpoints');
commandMap.set('api/v1/users', api_v1_usersCmd);


// Level 4: api v1 users create
const api_v1_users_createCmd = commandMap.get('api/v1/users')
    .command('create')
    .description('Create user via API');
api_v1_users_createCmd.argument('username', 'No description');
api_v1_users_createCmd.argument('email', 'No description');
api_v1_users_createCmd.option('--admin', 'Create as admin user');
api_v1_users_createCmd.option('--send-email', 'Send welcome email');
api_v1_users_createCmd.action(async (username, email, options) => {
    const globalOpts = program.opts();
    const verbose = globalOpts.verbose || false;
    
    try {
        const hookName = 'on_api_users_create';
        
        if (!hooks) {
            throw new CLIError('Hook module not loaded', 2);
        }
        
        if (typeof hooks[hookName] !== 'function') {
            const availableHooks = Object.keys(hooks).filter(key => typeof hooks[key] === 'function');
            const message = `Hook function '${hookName}' not implemented in src/hooks.js`;
            const details = availableHooks.length > 0 
                ? `Available hooks: ${availableHooks.join(', ')}`
                : 'No hook functions found in src/hooks.js';
            throw new CLIError(message, 2, details);
        }
        
        // Execute the hook function with proper error handling
        const args = [username, email];
        const result = await hooks[hookName](...args, options);
        
        // Handle return codes
        if (typeof result === 'number' && result !== 0) {
            throw new CLIError(`Command 'api v1 users create' failed with exit code ${result}`, result);
        }
        
    } catch (error) {
        if (error.code === 'SIGINT' || error.message.includes('interrupted')) {
            console.error('\\nCommand interrupted by user');
            process.exit(130);
        }
        
        handleError(error, 'Command execution', verbose);
    }
});
commandMap.set('api/v1/users/create', api_v1_users_createCmd);


// Level 4: api v1 users permissions
const api_v1_users_permissionsCmd = commandMap.get('api/v1/users')
    .command('permissions')
    .description('Manage user permissions');
commandMap.set('api/v1/users/permissions', api_v1_users_permissionsCmd);


// Level 5: api v1 users permissions grant
const api_v1_users_permissions_grantCmd = commandMap.get('api/v1/users/permissions')
    .command('grant')
    .description('Grant permission to user');
api_v1_users_permissions_grantCmd.argument('user_id', 'No description');
api_v1_users_permissions_grantCmd.argument('permission', 'No description');
api_v1_users_permissions_grantCmd.option('--expires', 'Permission expiration');
api_v1_users_permissions_grantCmd.action(async (user_id, permission, options) => {
    const globalOpts = program.opts();
    const verbose = globalOpts.verbose || false;
    
    try {
        const hookName = 'on_api_permissions_grant';
        
        if (!hooks) {
            throw new CLIError('Hook module not loaded', 2);
        }
        
        if (typeof hooks[hookName] !== 'function') {
            const availableHooks = Object.keys(hooks).filter(key => typeof hooks[key] === 'function');
            const message = `Hook function '${hookName}' not implemented in src/hooks.js`;
            const details = availableHooks.length > 0 
                ? `Available hooks: ${availableHooks.join(', ')}`
                : 'No hook functions found in src/hooks.js';
            throw new CLIError(message, 2, details);
        }
        
        // Execute the hook function with proper error handling
        const args = [user_id, permission];
        const result = await hooks[hookName](...args, options);
        
        // Handle return codes
        if (typeof result === 'number' && result !== 0) {
            throw new CLIError(`Command 'api v1 users permissions grant' failed with exit code ${result}`, result);
        }
        
    } catch (error) {
        if (error.code === 'SIGINT' || error.message.includes('interrupted')) {
            console.error('\\nCommand interrupted by user');
            process.exit(130);
        }
        
        handleError(error, 'Command execution', verbose);
    }
});
commandMap.set('api/v1/users/permissions/grant', api_v1_users_permissions_grantCmd);


// Level 5: api v1 users permissions revoke
const api_v1_users_permissions_revokeCmd = commandMap.get('api/v1/users/permissions')
    .command('revoke')
    .description('Revoke permission from user');
api_v1_users_permissions_revokeCmd.argument('user_id', 'No description');
api_v1_users_permissions_revokeCmd.argument('permission', 'No description');
api_v1_users_permissions_revokeCmd.option('--force', 'Force revocation');
api_v1_users_permissions_revokeCmd.action(async (user_id, permission, options) => {
    const globalOpts = program.opts();
    const verbose = globalOpts.verbose || false;
    
    try {
        const hookName = 'on_api_permissions_revoke';
        
        if (!hooks) {
            throw new CLIError('Hook module not loaded', 2);
        }
        
        if (typeof hooks[hookName] !== 'function') {
            const availableHooks = Object.keys(hooks).filter(key => typeof hooks[key] === 'function');
            const message = `Hook function '${hookName}' not implemented in src/hooks.js`;
            const details = availableHooks.length > 0 
                ? `Available hooks: ${availableHooks.join(', ')}`
                : 'No hook functions found in src/hooks.js';
            throw new CLIError(message, 2, details);
        }
        
        // Execute the hook function with proper error handling
        const args = [user_id, permission];
        const result = await hooks[hookName](...args, options);
        
        // Handle return codes
        if (typeof result === 'number' && result !== 0) {
            throw new CLIError(`Command 'api v1 users permissions revoke' failed with exit code ${result}`, result);
        }
        
    } catch (error) {
        if (error.code === 'SIGINT' || error.message.includes('interrupted')) {
            console.error('\\nCommand interrupted by user');
            process.exit(130);
        }
        
        handleError(error, 'Command execution', verbose);
    }
});
commandMap.set('api/v1/users/permissions/revoke', api_v1_users_permissions_revokeCmd);


program.parse();