#!/usr/bin/env node
/**
 * Post-install script for test_ts
 * Generated by Goobits CLI Universal Template System
 * 
 * This script runs after npm install to set up the CLI environment
 */

const fs = require('fs');
const path = require('path');
const os = require('os');

// Configuration
const CONFIG = {
    packageName: 'test_ts',
    commandName: 'testts',
    displayName: 'test_ts',
    configDirName: 'test_ts'
};

// Color codes for console output
const colors = {
    reset: '\x1b[0m',
    red: '\x1b[31m',
    green: '\x1b[32m',
    yellow: '\x1b[33m',
    blue: '\x1b[34m'
};

// Logging utilities
const log = {
    info: (msg) => console.log(`${colors.blue}[INFO]${colors.reset} ${msg}`),
    success: (msg) => console.log(`${colors.green}[SUCCESS]${colors.reset} ${msg}`),
    warning: (msg) => console.log(`${colors.yellow}[WARNING]${colors.reset} ${msg}`),
    error: (msg) => console.error(`${colors.red}[ERROR]${colors.reset} ${msg}`)
};

/**
 * Set executable permissions on CLI files
 */
function setExecutablePermissions() {
    const binFiles = [
        'bin/cli.js',
        'cli.js',
        'index.js'
    ];

    binFiles.forEach(file => {
        if (fs.existsSync(file)) {
            try {
                fs.chmodSync(file, 0o755);
                log.success(`Set executable permissions on ${file}`);
            } catch (err) {
                log.warning(`Could not set permissions on ${file}: ${err.message}`);
            }
        }
    });
}

/**
 * Get user configuration directory based on platform
 */
function getConfigDir() {
    const homeDir = os.homedir();
    
    if (process.platform === 'win32') {
        // Windows: Use APPDATA or fallback to home
        return path.join(process.env.APPDATA || homeDir, CONFIG.configDirName);
    } else if (process.platform === 'darwin') {
        // macOS: Use ~/Library/Application Support
        return path.join(homeDir, 'Library', 'Application Support', CONFIG.configDirName);
    } else {
        // Linux and others: Use XDG_CONFIG_HOME or ~/.config
        const xdgConfig = process.env.XDG_CONFIG_HOME || path.join(homeDir, '.config');
        return path.join(xdgConfig, CONFIG.configDirName);
    }
}

/**
 * Create configuration directory if it doesn't exist
 */
function createConfigDirectory() {
    const configDir = getConfigDir();
    
    try {
        if (!fs.existsSync(configDir)) {
            fs.mkdirSync(configDir, { recursive: true });
            log.success(`Created configuration directory: ${configDir}`);
        } else {
            log.info(`Configuration directory already exists: ${configDir}`);
        }
        
        // Create default config file if it doesn't exist
        const configFile = path.join(configDir, 'config.json');
        if (!fs.existsSync(configFile)) {
            const defaultConfig = {
                version: '1.0.0',
// Default configuration will be added here            };
            
            fs.writeFileSync(configFile, JSON.stringify(defaultConfig, null, 2));
            log.success(`Created default configuration file: ${configFile}`);
        }
        
        return true;
    } catch (error) {
        log.error(`Failed to create configuration directory: ${error.message}`);
        return false;
    }
}

/**
 * Check if running in global installation context
 */
function isGlobalInstall() {
    // Check if npm_config_global is set (npm install -g)
    if (process.env.npm_config_global === 'true') {
        return true;
    }
    
    // Check if we're in node_modules/.bin (local install)
    const scriptPath = process.argv[1];
    return !scriptPath.includes('node_modules');
}

/**
 * Validate Node.js version
 */
function validateNodeVersion() {
    const nodeVersion = process.version;
    const majorVersion = parseInt(nodeVersion.split('.')[0].substring(1));
    
    if (majorVersion < 14) {
        log.warning(`Node.js ${nodeVersion} detected. Recommended version is 14.x or higher.`);
        return false;
    }
    
    return true;
}

/**
 * Create command shortcuts for Windows
 */
function createWindowsShortcuts() {
    if (process.platform !== 'win32') {
        return;
    }
    
    try {
        // Create batch file wrapper for better Windows support
        const batchContent = `@echo off
node "%~dp0\\cli.js" %*
`;
        const batchFile = path.join(path.dirname(process.argv[1]), `${CONFIG.commandName}.cmd`);
        fs.writeFileSync(batchFile, batchContent);
        log.success(`Created Windows command wrapper: ${CONFIG.commandName}.cmd`);
    } catch (error) {
        log.warning(`Could not create Windows shortcuts: ${error.message}`);
    }
}

/**
 * Main post-install function
 */
async function main() {
    console.log('');
    log.info(`Running post-install setup for ${CONFIG.displayName}...`);
    console.log('');
    
    // Set executable permissions on CLI files
    setExecutablePermissions();
    
    // Validate environment
    validateNodeVersion();
    
    // Create configuration directory
    createConfigDirectory();
    
    // Platform-specific setup
    if (process.platform === 'win32') {
        createWindowsShortcuts();
    }
    
    // Check if global install
    if (isGlobalInstall()) {
        log.info(`Global installation detected`);
console.log('');
        log.success(`${CONFIG.displayName} has been installed globally!`);
        console.log(`You can now use: ${CONFIG.commandName}`);    } else {
        log.info(`Local installation detected`);
        console.log('');
        console.log(`To use ${CONFIG.commandName} globally, run: npm link`);
    }
    
    console.log('');
    log.success('ðŸ“¦ Post-installation setup completed');
}

// Run post-install only if not in CI/CD environment
if (!process.env.CI && !process.env.CONTINUOUS_INTEGRATION) {
    main().catch(error => {
        log.error(`Post-install failed: ${error.message}`);
        // Don't exit with error to not break npm install
        process.exit(0);
    });
} else {
    console.log('ðŸ“¦ Skipping post-install setup in CI/CD environment');
}