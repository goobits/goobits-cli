#!/usr/bin/env node
/**
 * Interactive mode for Test Universal CLI
 * Generated by Goobits CLI Framework
 */

import * as readline from 'readline';
import * as hooks from './hooks';

interface Command {
    description: string;
    handler: (args: string[]) => Promise<void>;
}

export class TestuniversalcliInteractive {
    private rl: readline.Interface;
    private commands: Record<string, Command>;
    private commandHistory: string[] = [];

    constructor() {
        this.rl = readline.createInterface({
            input: process.stdin,
            output: process.stdout,
            prompt: 'Test CLI> ',
            completer: this.completer.bind(this)
        });
        
        this.commands = {            'hello': {
                description: 'Say hello to someone',
                handler: this.handleHello.bind(this)
            },            'help': {
                description: 'Show available commands',
                handler: this.handleHelp.bind(this)
            },
            'exit': {
                description: 'Exit interactive mode',
                handler: this.handleExit.bind(this)
            },
            'quit': {
                description: 'Exit interactive mode',
                handler: this.handleExit.bind(this)
            }
        };
    }
    
    public start(): void {
        console.log("Welcome to Test Universal CLI interactive mode. Type 'help' for commands, 'exit' to quit.");
        
        this.rl.prompt();
        
        this.rl.on('line', async (line: string) => {
            const trimmed = line.trim();
            if (!trimmed) {
                this.rl.prompt();
                return;
            }
            
            this.commandHistory.push(trimmed);
            const [cmd, ...args] = trimmed.split(/\s+/);
            
            if (this.commands[cmd]) {
                try {
                    await this.commands[cmd].handler(args);
                } catch (error) {
                    console.error('Error:', (error as Error).message);
                }
            } else {
                console.log(`Unknown command: ${cmd}`);
                console.log("Type 'help' for available commands");
            }
            
            this.rl.prompt();
        });
        
        this.rl.on('close', () => {
            console.log('\nGoodbye!');
            process.exit(0);
        });
    }
    
    private completer(line: string): [string[], string] {
        const completions = Object.keys(this.commands);
        const hits = completions.filter((c) => c.startsWith(line));
        return [hits.length ? hits : completions, line];
    }
    
    private async handleHelp(args: string[]): Promise<void> {
        console.log('\nAvailable commands:');
        for (const [cmd, info] of Object.entries(this.commands)) {
            console.log(`  ${cmd.padEnd(15)} ${info.description}`);
        }
        console.log();
    }
    
    private async handleExit(args: string[]): Promise<void> {
        this.rl.close();
    }    
    private async handleHello(args: string[]): Promise<void> {
        const hookName = 'on_hello' as keyof typeof hooks;
        if (typeof hooks[hookName] === 'function') {
            // Parse and validate arguments for the command
            const hookName = "on_hello";
            if (typeof hooks[hookName] === 'function') {
                try {
                    const result = await hooks[hookName](...args);
                    if (result !== undefined) {
                        console.log(result);
                    }
                } catch (error) {
                    console.error(`Error executing ${hookName}:`, error.message);
                }
            } else {
                console.log(`Command 'hello' executed successfully`);
                console.log(`To implement custom behavior, add '${hookName}' function to hooks.js`);
            }
            await (hooks[hookName] as Function)(...args);
        } else {
            console.log(`Command 'hello' executed successfully`);
            console.log(`To implement custom behavior, add '${hookName}' function to hooks.ts`);
        }
    }}

export function runInteractive(): void {
    const interactive = new TestuniversalcliInteractive();
    interactive.start();
}

if (require.main === module) {
    runInteractive();
}