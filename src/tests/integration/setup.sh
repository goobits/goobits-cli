#!/bin/bash
# Enhanced setup script for NodeJSTestCLI
# Generated by goobits-cli

set -e  # Exit on error

# Configuration
PACKAGE_NAME="nodejs-test-cli"
COMMAND_NAME="nodejstestcli"
DISPLAY_NAME="NodeJSTestCLI"
VERSION="1.2.3"
DESCRIPTION="A comprehensive Node.js CLI for testing all features."
NPM_NAME="nodejs-test-cli"

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
PURPLE='\033[0;35m'
NC='\033[0m' # No Color

# Enhanced progress tracking
PROGRESS_WIDTH=50
PROGRESS_CHAR="â–ˆ"
declare -A TASK_STATUS

# Progress and tree display functions
show_progress() {
    local current=$1
    local total=$2
    local task_name=$3
    
    local progress=$((current * PROGRESS_WIDTH / total))
    local remaining=$((PROGRESS_WIDTH - progress))
    
    printf "\r${BLUE}Progress:${NC} ["
    printf "%${progress}s" | tr ' ' "$PROGRESS_CHAR"
    printf "%${remaining}s" | tr ' ' 'Â·'
    printf "] %d/%d - %s" "$current" "$total" "$task_name"
}

print_tree_node() {
    local level=$1
    local is_last=$2
    local status=$3
    local message=$4
    local prefix=""
    
    # Build tree prefix
    for ((i=1; i<level; i++)); do
        prefix+="â”‚   "
    done
    
    if [ "$is_last" = true ]; then
        prefix+="â””â”€â”€ "
    else
        prefix+="â”œâ”€â”€ "
    fi
    
    # Status indicators
    case $status in
        "pending")
            echo -e "${prefix}${YELLOW}â³${NC} $message"
            ;;
        "running")
            echo -e "${prefix}${BLUE}ðŸ”„${NC} $message"
            ;;
        "success")
            echo -e "${prefix}${GREEN}âœ…${NC} $message"
            ;;
        "error")
            echo -e "${prefix}${RED}âŒ${NC} $message"
            ;;
        "skip")
            echo -e "${prefix}${CYAN}â­ï¸${NC} $message (skipped)"
            ;;
        "warning")
            echo -e "${prefix}${YELLOW}âš ï¸${NC} $message"
            ;;
        *)
            echo -e "${prefix}${NC}$message"
            ;;
    esac
}

# Logging functions
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Check if we're in a development environment
is_development() {
    [ -f "package.json" ] && [ -f "index.js" ]
}

# Check Node.js version
check_node_version() {
    local required_major_version=16
    
    if ! command -v node &> /dev/null; then
        print_tree_node 2 false "error" "Node.js is not installed"
        log_error "Node.js is required. Please install Node.js ${required_major_version}.x or higher."
        echo -e "\n${BLUE}Installation instructions:${NC}"
        echo "  Ubuntu/Debian: curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash - && sudo apt-get install -y nodejs"
        echo "  macOS: brew install node"
        echo "  Windows: Download from https://nodejs.org/"
        exit 1
    fi
    
    local node_version=$(node --version | cut -d 'v' -f 2)
    local major_version=$(echo "$node_version" | cut -d '.' -f 1)
    
    if [ "$major_version" -lt "$required_major_version" ]; then
        print_tree_node 2 false "error" "Node.js version $node_version is too old"
        log_error "Please upgrade to Node.js ${required_major_version}.x or higher."
        exit 1
    fi
    
    print_tree_node 2 false "success" "Node.js version $node_version detected"
}

# Check npm version
check_npm_version() {
    if ! command -v npm &> /dev/null; then
        print_tree_node 2 true "error" "npm is not installed"
        log_error "npm is required. Please install npm."
        exit 1
    fi
    
    local npm_version=$(npm --version)
    print_tree_node 2 true "success" "npm version $npm_version detected"
}

# Install system dependencies
install_system_dependencies() {
    print_tree_node 2 false "skip" "No system dependencies to install"
}

# Install npm dependencies
install_dependencies() {
    local install_mode=$1
    print_tree_node 2 false "running" "Installing npm dependencies"
    
    # Install production dependencies
    if [ "$install_mode" == "dev" ]; then
        npm install || {
            print_tree_node 3 false "error" "Failed to install dependencies"
            exit 1
        }
        print_tree_node 3 false "success" "All dependencies installed (dev mode)"
    else
        npm install --production || {
            print_tree_node 3 false "error" "Failed to install production dependencies"
            exit 1
        }
        print_tree_node 3 false "success" "Production dependencies installed"
    fi
    
}

# Create global link for development
create_dev_link() {
    print_tree_node 2 false "running" "Creating global development link"
    
    npm link || {
        print_tree_node 3 false "warning" "Failed to create global link"
        log_warning "You may need to use sudo: sudo npm link"
        return 1
    }
    
    print_tree_node 3 false "success" "Global link created"
}

# Install from npm registry
install_from_registry() {
    local global_install=$1
    
    if [ "$global_install" = true ]; then
        print_tree_node 2 false "running" "Installing $NPM_NAME globally from npm registry"
        
        npm install -g "$NPM_NAME" || {
            print_tree_node 3 false "warning" "Failed to install globally"
            log_warning "You may need to use sudo: sudo npm install -g $NPM_NAME"
            return 1
        }
        
        print_tree_node 3 false "success" "Installed globally"
    else
        print_tree_node 2 false "running" "Installing $NPM_NAME locally"
        npm install "$NPM_NAME" || {
            print_tree_node 3 false "error" "Failed to install locally"
            return 1
        }
        print_tree_node 3 false "success" "Installed locally"
    fi
}

# Setup configuration directory
setup_config_dir() {
    local config_dir
    
    # Platform-specific config directory
    case "$OSTYPE" in
        darwin*)
            config_dir="$HOME/Library/Application Support/nodejs-test-cli"
            ;;
        msys*|win32*)
            config_dir="${APPDATA:-$HOME}/nodejs-test-cli"
            ;;
        *)
            config_dir="${XDG_CONFIG_HOME:-$HOME/.config}/nodejs-test-cli"
            ;;
    esac
    
    print_tree_node 2 false "running" "Setting up configuration directory"
    
    if [ ! -d "$config_dir" ]; then
        mkdir -p "$config_dir" || {
            print_tree_node 3 false "error" "Failed to create config directory"
            return 1
        }
        print_tree_node 3 false "success" "Created config directory: $config_dir"
    else
        print_tree_node 3 false "skip" "Config directory already exists: $config_dir"
    fi
}

# Run post-install script if exists
run_postinstall() {
    if [ -f "scripts/postinstall.js" ]; then
        print_tree_node 2 false "running" "Running post-install configuration"
        node scripts/postinstall.js || {
            print_tree_node 3 false "warning" "Post-install script encountered issues"
        }
        print_tree_node 3 false "success" "Post-install configuration completed"
    else
        print_tree_node 2 false "skip" "No post-install script found"
    fi
}

# Validate installation
validate_installation() {
    print_tree_node 2 false "running" "Validating installation"
    
    # Check if command is available
    if command -v "$COMMAND_NAME" &> /dev/null; then
        local installed_version=$($COMMAND_NAME --version 2>/dev/null | head -n1 || echo "unknown")
        print_tree_node 3 false "success" "Command '$COMMAND_NAME' is available (version: $installed_version)"
    else
        print_tree_node 3 false "warning" "Command '$COMMAND_NAME' not found in PATH"
        return 1
    fi
    
    # Check if can show help
    if $COMMAND_NAME --help &> /dev/null; then
        print_tree_node 3 false "success" "Help command works correctly"
    else
        print_tree_node 3 false "warning" "Help command failed"
        return 1
    fi
}

# Uninstall function
uninstall() {
    echo ""
    echo -e "${RED}Uninstalling $DISPLAY_NAME...${NC}"
    echo "===================================="
    
    print_tree_node 1 false "running" "Checking installation method"
    
    # Check if globally installed
    if npm list -g "$NPM_NAME" &> /dev/null; then
        print_tree_node 2 false "running" "Removing global npm package"
        npm uninstall -g "$NPM_NAME" || {
            print_tree_node 3 false "error" "Failed to uninstall global package"
            log_warning "You may need to use sudo: sudo npm uninstall -g $NPM_NAME"
            exit 1
        }
        print_tree_node 3 false "success" "Global package removed"
    fi
    
    # Remove global link if it exists
    if npm list -g --link | grep -q "$PACKAGE_NAME"; then
        print_tree_node 2 false "running" "Removing global development link"
        npm unlink -g "$PACKAGE_NAME" || {
            print_tree_node 3 false "warning" "Failed to remove global link"
        }
        print_tree_node 3 false "success" "Global link removed"
    fi
    
    # Ask about configuration
    echo ""
    read -p "Remove configuration directory? [y/N]: " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        local config_dir="${XDG_CONFIG_HOME:-$HOME/.config}/nodejs-test-cli"
        if [ -d "$config_dir" ]; then
            print_tree_node 2 false "running" "Removing configuration directory"
            rm -rf "$config_dir"
            print_tree_node 3 false "success" "Configuration directory removed"
        fi
    fi
    
    echo ""
    log_success "Uninstallation completed!"
}

# Upgrade function
upgrade() {
    echo ""
    echo -e "${BLUE}Upgrading $DISPLAY_NAME...${NC}"
    echo "===================================="
    
    print_tree_node 1 false "running" "Checking current installation"
    
    # Check if globally installed
    if npm list -g "$NPM_NAME" &> /dev/null; then
        print_tree_node 2 false "running" "Upgrading global package"
        npm update -g "$NPM_NAME" || {
            print_tree_node 3 false "error" "Failed to upgrade global package"
            exit 1
        }
        print_tree_node 3 false "success" "Global package upgraded"
    elif is_development; then
        print_tree_node 2 false "running" "Upgrading development installation"
        git pull origin main || {
            print_tree_node 3 false "error" "Failed to pull latest changes"
            exit 1
        }
        install_dependencies "dev"
        print_tree_node 3 false "success" "Development installation upgraded"
    else
        print_tree_node 2 false "error" "No installation found to upgrade"
        exit 1
    fi
    
    validate_installation
    log_success "Upgrade completed!"
}

# Help function
show_help() {
    echo ""
    echo -e "${BLUE}NodeJSTestCLI Setup Script${NC}"
    echo "===================================="
    echo ""
    echo -e "${YELLOW}USAGE:${NC}"
    echo "  $0 [COMMAND] [OPTIONS]"
    echo ""
    echo -e "${YELLOW}COMMANDS:${NC}"
    echo "  install     Install the application (default)"
    echo "  uninstall   Remove the application"
    echo "  upgrade     Upgrade to latest version"
    echo "  validate    Validate current installation"
    echo ""
    echo -e "${YELLOW}INSTALL OPTIONS:${NC}"
    echo "  --dev, -d      Install in development mode with npm link"
    echo "  --global, -g   Install globally from npm registry"
    echo "  --local        Install locally (default)"
    echo ""
    echo -e "${YELLOW}GENERAL OPTIONS:${NC}"
    echo "  --help, -h     Show this help message"
    echo "  --version, -v  Show version information"
    echo "  --verbose      Enable verbose output"
    echo ""
    echo -e "${YELLOW}EXAMPLES:${NC}"
    echo "  $0 install --dev       # Development installation"
    echo "  $0 install --global    # Global installation"
    echo "  $0 upgrade             # Upgrade existing installation"
    echo "  $0 uninstall           # Remove application"
    echo ""
}

# Main installation function
install() {
    local install_mode="production"
    local dev_mode=false
    local global_mode=false
    local total_tasks=8
    local current_task=0
    
    echo ""
    echo -e "${PURPLE}Installing $DISPLAY_NAME v$VERSION${NC}"
    echo "===================================="
    echo -e "${CYAN}$DESCRIPTION${NC}"
    echo ""
    
    # Task 1: Prerequisites
    ((current_task++))
    show_progress $current_task $total_tasks "Checking prerequisites"
    echo ""
    print_tree_node 1 false "running" "Checking prerequisites"
    check_node_version
    check_npm_version
    
    # Task 2: System dependencies
    ((current_task++))
    show_progress $current_task $total_tasks "Installing system dependencies"
    echo ""
    print_tree_node 1 false "running" "Installing system dependencies"
    install_system_dependencies
    
    # Task 3: npm dependencies
    ((current_task++))
    show_progress $current_task $total_tasks "Installing npm dependencies"
    echo ""
    print_tree_node 1 false "running" "Installing npm dependencies"
    
    if [ "$global_mode" = true ]; then
        install_from_registry true
    elif is_development; then
        install_dependencies "$install_mode"
    else
        install_from_registry false
    fi
    
    # Task 4: Configuration
    ((current_task++))
    show_progress $current_task $total_tasks "Setting up configuration"
    echo ""
    print_tree_node 1 false "running" "Setting up configuration"
    setup_config_dir
    
    # Task 5: Post-install
    ((current_task++))
    show_progress $current_task $total_tasks "Running post-install tasks"
    echo ""
    print_tree_node 1 false "running" "Running post-install tasks"
    run_postinstall
    
    # Task 6: Development link
    if [ "$dev_mode" = true ] && is_development; then
        ((current_task++))
        show_progress $current_task $total_tasks "Creating development link"
        echo ""
        print_tree_node 1 false "running" "Creating development link"
        create_dev_link
    else
        ((current_task++))
        show_progress $current_task $total_tasks "Skipping development link"
        echo ""
        print_tree_node 1 false "skip" "Development link not needed"
    fi
    
    # Task 7: Making executable
    if is_development; then
        ((current_task++))
        show_progress $current_task $total_tasks "Making CLI executable"
        echo ""
        print_tree_node 1 false "running" "Making CLI executable"
        chmod +x *.js 2>/dev/null || true
        print_tree_node 2 false "success" "CLI files made executable"
    else
        ((current_task++))
        show_progress $current_task $total_tasks "Skipping executable setup"
        echo ""
        print_tree_node 1 false "skip" "Not in development mode"
    fi
    
    # Task 8: Validation
    ((current_task++))
    show_progress $current_task $total_tasks "Validating installation"
    echo ""
    print_tree_node 1 false "running" "Validating installation"
    if validate_installation; then
        print_tree_node 2 false "success" "Installation validated successfully"
    else
        print_tree_node 2 false "warning" "Installation validation had issues"
    fi
    
    # Clear progress line
    echo ""
    echo ""
    echo "===================================="
    log_success "Installation completed successfully!"
    echo ""
    
    # Show usage instructions
    if [ "$dev_mode" = true ]; then
        echo -e "${GREEN}Development mode enabled:${NC}"
        echo "  â€¢ CLI is linked globally as: $COMMAND_NAME"
        echo "  â€¢ Changes to source code will be reflected immediately"
    elif [ "$global_mode" = true ]; then
        echo -e "${GREEN}Global installation completed:${NC}"
        echo "  â€¢ Use anywhere: $COMMAND_NAME"
    else
        echo -e "${GREEN}Local installation completed:${NC}"
        echo "  â€¢ Run locally: ./index.js"
        echo "  â€¢ Or install globally: npm install -g ."
    fi
    
    echo ""
    echo -e "${BLUE}Next steps:${NC}"
    echo "  â€¢ Run '$COMMAND_NAME --help' for usage information"
    echo "  â€¢ Check '$COMMAND_NAME config path' for configuration location"
    echo "  â€¢ Visit our documentation for more details"
    echo ""
}

# Main function
main() {
    local command="install"
    local dev_mode=false
    local global_mode=false
    local verbose=false
    
    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            install)
                command="install"
                shift
                ;;
            uninstall)
                command="uninstall"
                shift
                ;;
            upgrade)
                command="upgrade"
                shift
                ;;
            validate)
                command="validate"
                shift
                ;;
            --dev|-d)
                dev_mode=true
                shift
                ;;
            --global|-g)
                global_mode=true
                shift
                ;;
            --local)
                # Default behavior
                shift
                ;;
            --verbose)
                verbose=true
                set -x
                shift
                ;;
            --help|-h)
                show_help
                exit 0
                ;;
            --version|-v)
                echo "$DISPLAY_NAME v$VERSION"
                exit 0
                ;;
            *)
                log_error "Unknown option: $1"
                echo "Use --help for usage information"
                exit 1
                ;;
        esac
    done
    
    # Execute command
    case $command in
        install)
            if [ "$dev_mode" = true ]; then
                install_mode="dev"
            fi
            install
            ;;
        uninstall)
            uninstall
            ;;
        upgrade)
            upgrade
            ;;
        validate)
            echo ""
            echo "Validating $DISPLAY_NAME installation..."
            echo "===================================="
            print_tree_node 1 false "running" "Running validation"
            if validate_installation; then
                log_success "Installation is valid!"
            else
                log_error "Installation validation failed!"
                exit 1
            fi
            ;;
        *)
            log_error "Unknown command: $command"
            show_help
            exit 1
            ;;
    esac
}

# Run main function
main "$@"