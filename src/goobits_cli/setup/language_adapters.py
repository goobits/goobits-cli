"""
Language Adapters for Setup
============================

Language-specific adapters for generating setup and installation scripts.
Each adapter generates equivalent setup functionality for its target language.
"""

from typing import Dict, Any
from ..universal.language_adapters import LanguageAdapter


class PythonSetupAdapter(LanguageAdapter):
    """Python adapter for setup script generation."""
    
    def generate_imports(self, config: Dict[str, Any]) -> str:
        """Generate Python setup script imports."""
        return '''#!/bin/bash
# Python Setup Script
# Generated by Goobits CLI Framework

set -e

# Performance optimizations
export LC_ALL=C
export LANG=C
export PYTHONDONTWRITEBYTECODE=1'''
    
    def generate_setup_functions(self, config: Dict[str, Any]) -> str:
        """Generate Python setup functions."""
        package_name = config.get('package_name', 'app')
        python_version = config.get('python_version', '3.8')
        
        return f'''
# Colors and formatting
readonly RED='\\033[0;31m'
readonly GREEN='\\033[0;32m'
readonly YELLOW='\\033[1;33m'
readonly BLUE='\\033[0;34m'
readonly NC='\\033[0m'

validate_python() {{
    if ! command -v python3 >/dev/null 2>&1; then
        echo -e "${{RED}}✗${{NC}} Python 3 not found. Please install Python {python_version} or later."
        return 1
    fi
    
    local python_version=$(python3 --version 2>&1 | cut -d' ' -f2)
    echo -e "${{GREEN}}✓${{NC}} Found Python $python_version"
    return 0
}}

install_package() {{
    local dev_mode="$1"
    
    echo -e "${{BLUE}}Installing Python package...${{NC}}"
    
    if command -v pipx >/dev/null 2>&1 && [[ "$dev_mode" != "true" ]]; then
        echo -e "${{BLUE}}Using pipx for isolated installation...${{NC}}"
        pipx install "{package_name}"
    elif [[ "$dev_mode" == "true" ]]; then
        echo -e "${{BLUE}}Installing in development mode...${{NC}}"
        pip install -e ".[dev]"
    else
        echo -e "${{BLUE}}Using pip...${{NC}}"
        pip install --user "{package_name}"
    fi
    
    echo -e "${{GREEN}}✓ Installation completed successfully!${{NC}}"
    return 0
}}

upgrade_package() {{
    echo -e "${{BLUE}}Upgrading package...${{NC}}"
    
    if command -v pipx >/dev/null 2>&1; then
        pipx upgrade "{package_name}"
    else
        pip install --upgrade --user "{package_name}"
    fi
    
    echo -e "${{GREEN}}✓ Upgrade completed successfully!${{NC}}"
}}

uninstall_package() {{
    echo -e "${{BLUE}}Uninstalling package...${{NC}}"
    
    if command -v pipx >/dev/null 2>&1; then
        pipx uninstall "{package_name}"
    else
        pip uninstall -y "{package_name}"
    fi
    
    echo -e "${{GREEN}}✓ Uninstall completed successfully!${{NC}}"
}}'''
    
    def generate_main_function(self, config: Dict[str, Any]) -> str:
        """Generate Python setup main function."""
        return '''
main() {
    local command="${1:-install}"
    local dev_flag="false"
    
    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            install|upgrade|uninstall|validate)
                command="$1"
                ;;
            --dev)
                dev_flag="true"
                ;;
            *)
                echo "Usage: $0 {install|upgrade|uninstall|validate} [--dev]"
                exit 1
                ;;
        esac
        shift
    done
    
    case $command in
        validate)
            validate_python
            ;;
        install)
            validate_python && install_package "$dev_flag"
            ;;
        upgrade)
            validate_python && upgrade_package
            ;;
        uninstall)
            uninstall_package
            ;;
        *)
            echo "Unknown command: $command"
            exit 1
            ;;
    esac
}

main "$@"'''


class NodeJSSetupAdapter(LanguageAdapter):
    """Node.js adapter for setup script generation."""
    
    def generate_imports(self, config: Dict[str, Any]) -> str:
        """Generate Node.js setup script imports."""
        return '''#!/bin/bash
# Node.js Setup Script
# Generated by Goobits CLI Framework

set -e'''
    
    def generate_setup_functions(self, config: Dict[str, Any]) -> str:
        """Generate Node.js setup functions."""
        package_name = config.get('package_name', 'app')
        
        return f'''
# Colors
RED='\\033[0;31m'
GREEN='\\033[0;32m'
BLUE='\\033[0;34m'
NC='\\033[0m'

validate_nodejs() {{
    if ! command -v node >/dev/null 2>&1; then
        echo -e "${{RED}}✗${{NC}} Node.js not found. Please install Node.js from nodejs.org"
        return 1
    fi
    
    if ! command -v npm >/dev/null 2>&1; then
        echo -e "${{RED}}✗${{NC}} npm not found. Please install npm"
        return 1
    fi
    
    local node_version=$(node --version)
    echo -e "${{GREEN}}✓${{NC}} Found Node.js $node_version"
    return 0
}}

install_package() {{
    local global_flag="$1"
    
    echo -e "${{BLUE}}Installing Node.js package...${{NC}}"
    
    if [[ "$global_flag" == "true" ]]; then
        npm install -g "{package_name}"
    else
        npm install "{package_name}"
    fi
    
    echo -e "${{GREEN}}✓ Installation completed successfully!${{NC}}"
}}

upgrade_package() {{
    echo -e "${{BLUE}}Upgrading package...${{NC}}"
    npm update "{package_name}"
    echo -e "${{GREEN}}✓ Upgrade completed successfully!${{NC}}"
}}

uninstall_package() {{
    echo -e "${{BLUE}}Uninstalling package...${{NC}}"
    npm uninstall "{package_name}"
    echo -e "${{GREEN}}✓ Uninstall completed successfully!${{NC}}"
}}'''
    
    def generate_main_function(self, config: Dict[str, Any]) -> str:
        """Generate Node.js setup main function."""
        return '''
main() {
    local command="${1:-install}"
    local global_flag="false"
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            install|upgrade|uninstall|validate)
                command="$1"
                ;;
            --global)
                global_flag="true"
                ;;
            *)
                echo "Usage: $0 {install|upgrade|uninstall|validate} [--global]"
                exit 1
                ;;
        esac
        shift
    done
    
    case $command in
        validate)
            validate_nodejs
            ;;
        install)
            validate_nodejs && install_package "$global_flag"
            ;;
        upgrade)
            validate_nodejs && upgrade_package
            ;;
        uninstall)
            uninstall_package
            ;;
        *)
            echo "Unknown command: $command"
            exit 1
            ;;
    esac
}

main "$@"'''


class TypeScriptSetupAdapter(LanguageAdapter):
    """TypeScript adapter for setup script generation."""
    
    def generate_imports(self, config: Dict[str, Any]) -> str:
        """Generate TypeScript setup script imports."""
        return '''#!/bin/bash
# TypeScript Setup Script
# Generated by Goobits CLI Framework

set -e'''
    
    def generate_setup_functions(self, config: Dict[str, Any]) -> str:
        """Generate TypeScript setup functions."""
        package_name = config.get('package_name', 'app')
        
        return f'''
# Colors
RED='\\033[0;31m'
GREEN='\\033[0;32m'
BLUE='\\033[0;34m'
NC='\\033[0m'

validate_typescript() {{
    if ! command -v node >/dev/null 2>&1; then
        echo -e "${{RED}}✗${{NC}} Node.js not found. Please install Node.js from nodejs.org"
        return 1
    fi
    
    if ! command -v npm >/dev/null 2>&1; then
        echo -e "${{RED}}✗${{NC}} npm not found. Please install npm"
        return 1
    fi
    
    echo -e "${{GREEN}}✓${{NC}} Node.js environment ready"
    return 0
}}

build_typescript() {{
    echo -e "${{BLUE}}Building TypeScript project...${{NC}}"
    
    if [ -f package.json ]; then
        if command -v tsc >/dev/null 2>&1; then
            tsc
        else
            npx tsc
        fi
    fi
    
    echo -e "${{GREEN}}✓ TypeScript build completed${{NC}}"
}}

install_package() {{
    local global_flag="$1"
    
    echo -e "${{BLUE}}Installing TypeScript package...${{NC}}"
    
    # Build first if needed
    build_typescript
    
    if [[ "$global_flag" == "true" ]]; then
        npm install -g "{package_name}"
    else
        npm install "{package_name}"
    fi
    
    echo -e "${{GREEN}}✓ Installation completed successfully!${{NC}}"
}}

upgrade_package() {{
    echo -e "${{BLUE}}Upgrading package...${{NC}}"
    build_typescript
    npm update "{package_name}"
    echo -e "${{GREEN}}✓ Upgrade completed successfully!${{NC}}"
}}

uninstall_package() {{
    echo -e "${{BLUE}}Uninstalling package...${{NC}}"
    npm uninstall "{package_name}"
    echo -e "${{GREEN}}✓ Uninstall completed successfully!${{NC}}"
}}'''
    
    def generate_main_function(self, config: Dict[str, Any]) -> str:
        """Generate TypeScript setup main function."""
        return '''
main() {
    local command="${1:-install}"
    local global_flag="false"
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            install|upgrade|uninstall|validate|build)
                command="$1"
                ;;
            --global)
                global_flag="true"
                ;;
            *)
                echo "Usage: $0 {install|upgrade|uninstall|validate|build} [--global]"
                exit 1
                ;;
        esac
        shift
    done
    
    case $command in
        validate)
            validate_typescript
            ;;
        build)
            validate_typescript && build_typescript
            ;;
        install)
            validate_typescript && install_package "$global_flag"
            ;;
        upgrade)
            validate_typescript && upgrade_package
            ;;
        uninstall)
            uninstall_package
            ;;
        *)
            echo "Unknown command: $command"
            exit 1
            ;;
    esac
}

main "$@"'''


class RustSetupAdapter(LanguageAdapter):
    """Rust adapter for setup script generation."""
    
    def generate_imports(self, config: Dict[str, Any]) -> str:
        """Generate Rust setup script imports."""
        return '''#!/bin/bash
# Rust Setup Script
# Generated by Goobits CLI Framework

set -e'''
    
    def generate_setup_functions(self, config: Dict[str, Any]) -> str:
        """Generate Rust setup functions."""
        package_name = config.get('package_name', 'app')
        
        return f'''
# Colors
RED='\\033[0;31m'
GREEN='\\033[0;32m'
BLUE='\\033[0;34m'
NC='\\033[0m'

validate_rust() {{
    if ! command -v rustc >/dev/null 2>&1; then
        echo -e "${{RED}}✗${{NC}} Rust not found. Please install Rust from rustup.rs"
        return 1
    fi
    
    if ! command -v cargo >/dev/null 2>&1; then
        echo -e "${{RED}}✗${{NC}} Cargo not found. Please install Cargo"
        return 1
    fi
    
    local rust_version=$(rustc --version)
    echo -e "${{GREEN}}✓${{NC}} Found $rust_version"
    return 0
}}

build_rust() {{
    echo -e "${{BLUE}}Building Rust project...${{NC}}"
    cargo build --release
    echo -e "${{GREEN}}✓ Build completed successfully${{NC}}"
}}

install_package() {{
    local from_source="$1"
    
    echo -e "${{BLUE}}Installing Rust package...${{NC}}"
    
    if [[ "$from_source" == "true" ]]; then
        build_rust
        cargo install --path .
    else
        cargo install "{package_name}"
    fi
    
    echo -e "${{GREEN}}✓ Installation completed successfully!${{NC}}"
}}

upgrade_package() {{
    echo -e "${{BLUE}}Upgrading package...${{NC}}"
    cargo install --force "{package_name}"
    echo -e "${{GREEN}}✓ Upgrade completed successfully!${{NC}}"
}}

uninstall_package() {{
    echo -e "${{BLUE}}Uninstalling package...${{NC}}"
    cargo uninstall "{package_name}"
    echo -e "${{GREEN}}✓ Uninstall completed successfully!${{NC}}"
}}'''
    
    def generate_main_function(self, config: Dict[str, Any]) -> str:
        """Generate Rust setup main function."""
        return '''
main() {
    local command="${1:-install}"
    local source_flag="false"
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            install|upgrade|uninstall|validate|build)
                command="$1"
                ;;
            --from-source)
                source_flag="true"
                ;;
            *)
                echo "Usage: $0 {install|upgrade|uninstall|validate|build} [--from-source]"
                exit 1
                ;;
        esac
        shift
    done
    
    case $command in
        validate)
            validate_rust
            ;;
        build)
            validate_rust && build_rust
            ;;
        install)
            validate_rust && install_package "$source_flag"
            ;;
        upgrade)
            validate_rust && upgrade_package
            ;;
        uninstall)
            uninstall_package
            ;;
        *)
            echo "Unknown command: $command"
            exit 1
            ;;
    esac
}

main "$@"'''