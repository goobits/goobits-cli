/**
 * Configuration management for {{ display_name }}
 * Generated by goobits-cli
 */

const fs = require('fs');
const path = require('path');
const os = require('os');

/**
 * Configuration manager class
 */
class ConfigManager {
    constructor() {
        this.packageName = '{{ package_name }}';
        this.configDirName = '{{ package_name }}';
        this.configFileName = 'config.json';
        this._config = null;
        this._configPath = null;
    }

    /**
     * Get the configuration directory path based on platform
     */
    getConfigDir() {
        const homeDir = os.homedir();
        
        if (process.platform === 'win32') {
            // Windows: Use APPDATA or fallback to home
            return path.join(process.env.APPDATA || homeDir, this.configDirName);
        } else if (process.platform === 'darwin') {
            // macOS: Use ~/Library/Application Support
            return path.join(homeDir, 'Library', 'Application Support', this.configDirName);
        } else {
            // Linux and others: Use XDG_CONFIG_HOME or ~/.config
            const xdgConfig = process.env.XDG_CONFIG_HOME || path.join(homeDir, '.config');
            return path.join(xdgConfig, this.configDirName);
        }
    }

    /**
     * Get the full path to the configuration file
     */
    getConfigPath() {
        if (!this._configPath) {
            this._configPath = path.join(this.getConfigDir(), this.configFileName);
        }
        return this._configPath;
    }

    /**
     * Ensure the configuration directory exists
     */
    ensureConfigDir() {
        const configDir = this.getConfigDir();
        if (!fs.existsSync(configDir)) {
            fs.mkdirSync(configDir, { recursive: true });
        }
    }

    /**
     * Load configuration from file
     */
    load() {
        const configPath = this.getConfigPath();
        
        try {
            if (fs.existsSync(configPath)) {
                const data = fs.readFileSync(configPath, 'utf8');
                this._config = JSON.parse(data);
            } else {
                // Create default config if file doesn't exist
                this._config = this.getDefaults();
                this.save();
            }
        } catch (error) {
            console.error(`Error loading config: ${error.message}`);
            this._config = this.getDefaults();
        }
        
        return this._config;
    }

    /**
     * Save configuration to file
     */
    save() {
        try {
            this.ensureConfigDir();
            const configPath = this.getConfigPath();
            fs.writeFileSync(configPath, JSON.stringify(this._config, null, 2));
            return true;
        } catch (error) {
            console.error(`Error saving config: ${error.message}`);
            return false;
        }
    }

    /**
     * Get configuration value by key (supports nested keys with dot notation)
     */
    get(key, defaultValue = undefined) {
        if (!this._config) {
            this.load();
        }
        
        if (!key) {
            return this._config;
        }
        
        // Support nested keys (e.g., 'api.endpoint')
        const keys = key.split('.');
        let value = this._config;
        
        for (const k of keys) {
            if (value && typeof value === 'object' && k in value) {
                value = value[k];
            } else {
                return defaultValue;
            }
        }
        
        return value;
    }

    /**
     * Set configuration value by key (supports nested keys with dot notation)
     */
    set(key, value) {
        if (!this._config) {
            this.load();
        }
        
        const keys = key.split('.');
        let current = this._config;
        
        // Navigate to the nested location
        for (let i = 0; i < keys.length - 1; i++) {
            const k = keys[i];
            if (!(k in current) || typeof current[k] !== 'object') {
                current[k] = {};
            }
            current = current[k];
        }
        
        // Set the value
        current[keys[keys.length - 1]] = value;
        
        // Auto-save
        return this.save();
    }

    /**
     * Delete configuration value by key
     */
    delete(key) {
        if (!this._config) {
            this.load();
        }
        
        const keys = key.split('.');
        let current = this._config;
        
        // Navigate to the parent of the key to delete
        for (let i = 0; i < keys.length - 1; i++) {
            const k = keys[i];
            if (!(k in current) || typeof current[k] !== 'object') {
                return false; // Key doesn't exist
            }
            current = current[k];
        }
        
        // Delete the key
        delete current[keys[keys.length - 1]];
        
        // Auto-save
        return this.save();
    }

    /**
     * Reset configuration to defaults
     */
    reset() {
        this._config = this.getDefaults();
        return this.save();
    }

    /**
     * Get default configuration
     */
    getDefaults() {
        return {
            version: '{{ version }}',
            {% if cli and cli.config_defaults %}
            ...{{ cli.config_defaults | json_stringify }}
            {% else %}
            // Add your default configuration here
            {% endif %}
        };
    }

    /**
     * Merge configuration with environment variables
     * Environment variables should be prefixed with {{ package_name | upper | replace('-', '_') }}_
     */
    mergeWithEnv() {
        const prefix = '{{ package_name | upper | replace("-", "_") }}_';
        const env = process.env;
        
        for (const key in env) {
            if (key.startsWith(prefix)) {
                const configKey = key
                    .substring(prefix.length)
                    .toLowerCase()
                    .replace(/_/g, '.');
                
                // Try to parse as JSON, fallback to string
                let value = env[key];
                try {
                    value = JSON.parse(value);
                } catch (e) {
                    // Keep as string
                }
                
                this.set(configKey, value);
            }
        }
    }
}

// Export singleton instance
module.exports = new ConfigManager();