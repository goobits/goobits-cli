#compdef {{ command_name }}
# Zsh completion script for {{ display_name }} ({{ command_name }})
# Auto-generated by goobits-cli

# Main completion function
_{{ command_name | replace('-', '_') }}() {
    local context state state_descr line
    typeset -A opt_args

    # Try dynamic completion first
    if _{{ command_name | replace('-', '_') }}_dynamic; then
        return 0
    fi

    # Fallback to static completion
    _{{ command_name | replace('-', '_') }}_static
}

# Dynamic completion using CLI's built-in completion
_{{ command_name | replace('-', '_') }}_dynamic() {
    local cli_bin="{{ command_name }}"
    
    # Check if CLI supports completion
    if ! command -v "$cli_bin" >/dev/null 2>&1; then
        return 1
    fi
    
    # Get completion suggestions from the CLI itself
    local suggestions
    suggestions=(${(f)"$("$cli_bin" _completion zsh "$words" "$#BUFFER" 2>/dev/null)"})
    
    if [[ $#suggestions -gt 0 ]]; then
        compadd -a suggestions
        return 0
    fi
    
    return 1
}

# Static completion as fallback
_{{ command_name | replace('-', '_') }}_static() {
    local context state state_descr line
    typeset -A opt_args

    _arguments -C \
        {% for option in cli.options %}
        '{% if option.short %}(-{{ option.short }} --{{ option.name }})'{-{{ option.short }},--{{ option.name }}}'{% else %}--{{ option.name }}{% endif %}[{{ option.desc }}]{% if option.type != "flag" %}:{{ option.type }}:{% if option.type == "file" %}_files{% elif option.type == "directory" %}_directories{% else %}_{{ command_name | replace('-', '_') }}_{{ option.name | replace('-', '_') }}{% endif %}{% endif %}' \
        {% endfor %}
        '(-h --help)'{-h,--help}'[Show help information]' \
        '(-V --version)'{-V,--version}'[Show version information]' \
        '1: :_{{ command_name | replace('-', '_') }}_commands' \
        '*::arg:->args' && return 0

    case $state in
        args)
            case $words[1] in
                {% for cmd_name, cmd_data in cli.commands.items() %}
                {{ cmd_name }})
                    {% if cmd_data.subcommands %}
                    _{{ command_name | replace('-', '_') }}_{{ cmd_name | replace('-', '_') }}_subcommands
                    {% else %}
                    _{{ command_name | replace('-', '_') }}_{{ cmd_name | replace('-', '_') }}
                    {% endif %}
                    ;;
                {% endfor %}
                plugin)
                    _{{ command_name | replace('-', '_') }}_plugin
                    ;;
                upgrade)
                    _{{ command_name | replace('-', '_') }}_upgrade
                    ;;
            esac
            ;;
    esac
}

# Command completion
_{{ command_name | replace('-', '_') }}_commands() {
    local commands=(
        {% for cmd_name, cmd_data in cli.commands.items() %}
        '{{ cmd_name }}:{% if cmd_data.icon %}{{ cmd_data.icon }} {% endif %}{{ cmd_data.desc }}'
        {% endfor %}
        {% if cli and (cli.enable_upgrade_command is not defined or cli.enable_upgrade_command) %}
        'upgrade:Upgrade {{ display_name }} to the latest version'
        {% endif %}
        'plugin:ðŸ”Œ Manage plugins for {{ display_name }}'
        'help:Show help information'
    )
    _describe 'commands' commands
}

{% for cmd_name, cmd_data in cli.commands.items() %}
{% if not cmd_data.subcommands %}
# {{ cmd_name }} command completion
_{{ command_name | replace('-', '_') }}_{{ cmd_name | replace('-', '_') }}() {
    _arguments \
        {% if cmd_data.options %}
        {% for opt in cmd_data.options %}
        '{% if opt.short %}(-{{ opt.short }} --{{ opt.name }})'{-{{ opt.short }},--{{ opt.name }}}'{% else %}--{{ opt.name }}{% endif %}[{{ opt.desc }}]{% if opt.type != "flag" %}:{{ opt.type }}:{% if opt.type == "file" %}_files{% elif opt.type == "directory" %}_directories{% elif opt.choices %}({{ opt.choices | join(' ') }}){% endif %}{% endif %}' \
        {% endfor %}
        {% endif %}
        '(-h --help)'{-h,--help}'[Show help for {{ cmd_name }} command]' \
        {% if cmd_data.args %}
        {% for arg in cmd_data.args %}
        '{% if not arg.required %}::{% else %}:{% endif %}{{ arg.name }}:{% if arg.choices %}({{ arg.choices | join(' ') }}){% elif arg.desc %}{{ arg.desc }}{% else %}{{ arg.name }}{% endif %}' \
        {% endfor %}
        {% endif %}
}
{% else %}
# {{ cmd_name }} subcommands completion
_{{ command_name | replace('-', '_') }}_{{ cmd_name | replace('-', '_') }}_subcommands() {
    local subcommands=(
        {% for subcmd_name, subcmd_data in cmd_data.subcommands.items() %}
        '{{ subcmd_name }}:{% if subcmd_data.icon %}{{ subcmd_data.icon }} {% endif %}{{ subcmd_data.desc }}'
        {% endfor %}
    )
    
    if [[ $CURRENT -eq 2 ]]; then
        _describe '{{ cmd_name }} subcommands' subcommands
    else
        case $words[2] in
            {% for subcmd_name, subcmd_data in cmd_data.subcommands.items() %}
            {{ subcmd_name }})
                _arguments \
                    {% if subcmd_data.options %}
                    {% for opt in subcmd_data.options %}
                    '{% if opt.short %}(-{{ opt.short }} --{{ opt.name }})'{-{{ opt.short }},--{{ opt.name }}}'{% else %}--{{ opt.name }}{% endif %}[{{ opt.desc }}]{% if opt.type != "flag" %}:{{ opt.type }}:{% if opt.type == "file" %}_files{% elif opt.type == "directory" %}_directories{% elif opt.choices %}({{ opt.choices | join(' ') }}){% endif %}{% endif %}' \
                    {% endfor %}
                    {% endif %}
                    '(-h --help)'{-h,--help}'[Show help for {{ subcmd_name }} subcommand]' \
                    {% if subcmd_data.args %}
                    {% for arg in subcmd_data.args %}
                    '{% if not arg.required %}::{% else %}:{% endif %}{{ arg.name }}:{% if arg.choices %}({{ arg.choices | join(' ') }}){% elif arg.desc %}{{ arg.desc }}{% else %}{{ arg.name }}{% endif %}' \
                    {% endfor %}
                    {% endif %}
                ;;
            {% endfor %}
        esac
    fi
}
{% endif %}
{% endfor %}

# Plugin command completion
_{{ command_name | replace('-', '_') }}_plugin() {
    local plugin_commands=(
        'list:List all available and loaded plugins'
        'install:Install a plugin from npm'
        'uninstall:Uninstall a plugin'
        'create:Create a new plugin template'
        'info:Show detailed information about a plugin'
    )
    
    if [[ $CURRENT -eq 2 ]]; then
        _describe 'plugin commands' plugin_commands
    else
        case $words[2] in
            list)
                _arguments \
                    '--json[Output as JSON]' \
                    '(-h --help)'{-h,--help}'[Show help for plugin list]'
                ;;
            install)
                _arguments \
                    '(-g --global)'{-g,--global}'[Install globally]' \
                    '--version[Install specific version]:version:' \
                    '(-h --help)'{-h,--help}'[Show help for plugin install]' \
                    ':plugin-name:'
                ;;
            uninstall|remove)
                _arguments \
                    '(-g --global)'{-g,--global}'[Uninstall globally]' \
                    '(-h --help)'{-h,--help}'[Show help for plugin uninstall]' \
                    ':plugin-name:'
                ;;
            create)
                _arguments \
                    '--type[Plugin type]:type:(function class npm)' \
                    '--dir[Output directory]:directory:_directories' \
                    '(-h --help)'{-h,--help}'[Show help for plugin create]' \
                    ':plugin-name:'
                ;;
            info)
                _arguments \
                    '(-h --help)'{-h,--help}'[Show help for plugin info]' \
                    ':plugin-name:'
                ;;
        esac
    fi
}

# Upgrade command completion
_{{ command_name | replace('-', '_') }}_upgrade() {
    _arguments \
        '--check[Check for updates without installing]' \
        '--version[Install specific version]:version:' \
        '--pre[Include pre-release versions]' \
        '--dry-run[Show what would be done without doing it]' \
        '(-h --help)'{-h,--help}'[Show help for upgrade command]'
}

# Custom completion functions for specific option types
{% for option in cli.options %}
{% if option.type not in ["flag", "file", "directory"] and not option.choices %}
_{{ command_name | replace('-', '_') }}_{{ option.name | replace('-', '_') }}() {
    # Custom completion for {{ option.name }} option
    # Add your custom completion logic here
    _default
}
{% endif %}
{% endfor %}

# Load the completion
_{{ command_name | replace('-', '_') }} "$@"

# Enable completion caching for better performance
zstyle ':completion:*:*:{{ command_name }}:*' cache-policy _{{ command_name | replace('-', '_') }}_cache_policy
_{{ command_name | replace('-', '_') }}_cache_policy() {
    # Cache completions for 1 hour
    [[ -n "$1" && "$1" -ot "$(date -v-1H)" ]]
}

# Add color support
zstyle ':completion:*:*:{{ command_name }}:*:descriptions' format '%F{green}-- %d --%f'
zstyle ':completion:*:*:{{ command_name }}:*:commands' group-name commands
zstyle ':completion:*:*:{{ command_name }}:*:options' group-name options

# Support for npx execution
compdef _{{ command_name | replace('-', '_') }} "npx {{ command_name }}"