#!/bin/bash
# Node.js-specific setup script for {{ display_name }}
# Generated by goobits-cli

set -e  # Exit on error

# Configuration
PACKAGE_NAME="{{ package_name }}"
COMMAND_NAME="{{ command_name }}"
DISPLAY_NAME="{{ display_name }}"
VERSION="{{ version }}"
DESCRIPTION="{{ description }}"

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Logging functions
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Check Node.js version
check_node_version() {
    local required_major_version=16
    
    if ! command -v node &> /dev/null; then
        log_error "Node.js is not installed. Please install Node.js ${required_major_version}.x or higher."
        exit 1
    fi
    
    local node_version=$(node --version | cut -d 'v' -f 2)
    local major_version=$(echo "$node_version" | cut -d '.' -f 1)
    
    if [ "$major_version" -lt "$required_major_version" ]; then
        log_error "Node.js version $node_version is too old. Please upgrade to Node.js ${required_major_version}.x or higher."
        exit 1
    fi
    
    log_success "Node.js version $node_version detected"
}

# Check npm version
check_npm_version() {
    if ! command -v npm &> /dev/null; then
        log_error "npm is not installed. Please install npm."
        exit 1
    fi
    
    local npm_version=$(npm --version)
    log_success "npm version $npm_version detected"
}

# Install npm dependencies
install_dependencies() {
    log_info "Installing npm dependencies..."
    
    # Install production dependencies
    if [ "$1" == "dev" ]; then
        npm install || {
            log_error "Failed to install dependencies"
            exit 1
        }
    else
        npm install --production || {
            log_error "Failed to install production dependencies"
            exit 1
        }
    fi
    
    log_success "Dependencies installed successfully"
}

# Create global link for development
create_dev_link() {
    log_info "Creating global link for development..."
    
    npm link || {
        log_warning "Failed to create global link. You may need to use sudo."
        log_info "Try running: sudo npm link"
        return 1
    }
    
    log_success "Global link created. You can now use '$COMMAND_NAME' from anywhere."
}

# Install globally from npm registry
install_global() {
    log_info "Installing $PACKAGE_NAME globally from npm registry..."
    
    npm install -g "$PACKAGE_NAME" || {
        log_warning "Failed to install globally. You may need to use sudo."
        log_info "Try running: sudo npm install -g $PACKAGE_NAME"
        return 1
    }
    
    log_success "Installed globally. You can now use '$COMMAND_NAME' from anywhere."
}

# Setup configuration directory
setup_config_dir() {
    local config_dir="$HOME/.config/{{ package_name }}"
    
    if [ ! -d "$config_dir" ]; then
        log_info "Creating configuration directory..."
        mkdir -p "$config_dir"
        log_success "Configuration directory created at $config_dir"
    fi
}

# Run post-install script if exists
run_postinstall() {
    if [ -f "scripts/postinstall.js" ]; then
        log_info "Running post-install configuration..."
        node scripts/postinstall.js || {
            log_warning "Post-install script encountered issues"
        }
    fi
}

# Main setup function
main() {
    echo ""
    echo "Setting up $DISPLAY_NAME..."
    echo "===================================="
    echo ""
    
    # Check prerequisites
    check_node_version
    check_npm_version
    
    # Determine installation mode
    local install_mode="production"
    local dev_mode=false
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --dev|-d)
                install_mode="dev"
                dev_mode=true
                shift
                ;;
            --global|-g)
                install_global
                setup_config_dir
                exit 0
                ;;
            --help|-h)
                echo "Usage: $0 [OPTIONS]"
                echo ""
                echo "Options:"
                echo "  --dev, -d     Install in development mode with npm link"
                echo "  --global, -g  Install globally from npm registry"
                echo "  --help, -h    Show this help message"
                echo ""
                exit 0
                ;;
            *)
                log_error "Unknown option: $1"
                exit 1
                ;;
        esac
    done
    
    # Install dependencies
    install_dependencies "$install_mode"
    
    # Make CLI executable
    chmod +x cli.js
    
    # Setup configuration directory
    setup_config_dir
    
    # Run post-install script
    run_postinstall
    
    # Create development link if in dev mode
    if [ "$dev_mode" = true ]; then
        create_dev_link
    fi
    
    echo ""
    echo "===================================="
    log_success "Setup complete!"
    echo ""
    
    if [ "$dev_mode" = true ]; then
        echo "Development mode enabled. The CLI is linked globally."
        echo "You can now use: $COMMAND_NAME"
    else
        echo "You can run the CLI locally with: ./cli.js"
        echo "Or install globally with: npm install -g ."
    fi
    
    echo ""
}

# Run main function
main "$@"