# Fish completion script for {{ display_name }} ({{ command_name }})
# Auto-generated by goobits-cli

# Main completion function
function __{{ command_name | replace('-', '_') }}_complete
    set -l cmd (commandline -opc)
    set -l current (commandline -ct)
    
    # Try dynamic completion first
    if __{{ command_name | replace('-', '_') }}_dynamic_complete $cmd $current
        return 0
    end
    
    # Fallback to static completion
    __{{ command_name | replace('-', '_') }}_static_complete $cmd $current
end

# Dynamic completion using CLI's built-in completion
function __{{ command_name | replace('-', '_') }}_dynamic_complete
    set -l cmd $argv[1..-2]
    set -l current $argv[-1]
    
    # Check if CLI supports completion
    if not command -v {{ command_name }} >/dev/null 2>&1
        return 1
    end
    
    # Get completion suggestions from the CLI itself
    set -l suggestions ({{ command_name }} _completion fish (commandline -cp) (commandline -C) 2>/dev/null)
    
    if test $status -eq 0; and test -n "$suggestions"
        for suggestion in $suggestions
            echo $suggestion
        end
        return 0
    end
    
    return 1
end

# Static completion as fallback
function __{{ command_name | replace('-', '_') }}_static_complete
    set -l cmd $argv[1..-2]
    set -l current $argv[-1]
    
    # Remove the command name itself
    set -e cmd[1]
    
    # If no subcommand yet, complete with main commands
    if test (count $cmd) -eq 0
        __{{ command_name | replace('-', '_') }}_complete_commands
        return 0
    end
    
    # Handle subcommand completion
    switch $cmd[1]
        {% for cmd_name, cmd_data in cli.commands.items() %}
        case '{{ cmd_name }}'
            {% if cmd_data.subcommands %}
            __{{ command_name | replace('-', '_') }}_complete_{{ cmd_name | replace('-', '_') }}_subcommands $cmd[2..-1]
            {% else %}
            __{{ command_name | replace('-', '_') }}_complete_{{ cmd_name | replace('-', '_') }}_options $cmd[2..-1]
            {% endif %}
        {% endfor %}
        case 'plugin'
            __{{ command_name | replace('-', '_') }}_complete_plugin $cmd[2..-1]
        case 'upgrade'
            __{{ command_name | replace('-', '_') }}_complete_upgrade $cmd[2..-1]
        case 'help'
            __{{ command_name | replace('-', '_') }}_complete_commands
    end
end

# Complete main commands
function __{{ command_name | replace('-', '_') }}_complete_commands
    {% for cmd_name, cmd_data in cli.commands.items() %}
    echo '{{ cmd_name }}\t{% if cmd_data.icon %}{{ cmd_data.icon }} {% endif %}{{ cmd_data.desc }}'
    {% endfor %}
    {% if cli and (cli.enable_upgrade_command is not defined or cli.enable_upgrade_command) %}
    echo 'upgrade\tUpgrade {{ display_name }} to the latest version'
    {% endif %}
    echo 'plugin\tðŸ”Œ Manage plugins for {{ display_name }}'
    echo 'help\tShow help information'
end

{% for cmd_name, cmd_data in cli.commands.items() %}
{% if not cmd_data.subcommands %}
# Complete {{ cmd_name }} command options
function __{{ command_name | replace('-', '_') }}_complete_{{ cmd_name | replace('-', '_') }}_options
    {% if cmd_data.options %}
    {% for opt in cmd_data.options %}
    echo '--{{ opt.name }}\t{{ opt.desc }}'
    {% if opt.short %}
    echo '-{{ opt.short }}\t{{ opt.desc }}'
    {% endif %}
    {% endfor %}
    {% endif %}
    echo '--help\tShow help for {{ cmd_name }} command'
    echo '-h\tShow help for {{ cmd_name }} command'
end
{% else %}
# Complete {{ cmd_name }} subcommands
function __{{ command_name | replace('-', '_') }}_complete_{{ cmd_name | replace('-', '_') }}_subcommands
    set -l subcmd $argv
    
    if test (count $subcmd) -eq 0
        # List subcommands
        {% for subcmd_name, subcmd_data in cmd_data.subcommands.items() %}
        echo '{{ subcmd_name }}\t{% if subcmd_data.icon %}{{ subcmd_data.icon }} {% endif %}{{ subcmd_data.desc }}'
        {% endfor %}
    else
        # Complete subcommand options
        switch $subcmd[1]
            {% for subcmd_name, subcmd_data in cmd_data.subcommands.items() %}
            case '{{ subcmd_name }}'
                {% if subcmd_data.options %}
                {% for opt in subcmd_data.options %}
                echo '--{{ opt.name }}\t{{ opt.desc }}'
                {% if opt.short %}
                echo '-{{ opt.short }}\t{{ opt.desc }}'
                {% endif %}
                {% endfor %}
                {% endif %}
                echo '--help\tShow help for {{ subcmd_name }} subcommand'
                echo '-h\tShow help for {{ subcmd_name }} subcommand'
            {% endfor %}
        end
    end
end
{% endif %}
{% endfor %}

# Complete plugin command
function __{{ command_name | replace('-', '_') }}_complete_plugin
    set -l subcmd $argv
    
    if test (count $subcmd) -eq 0
        echo 'list\tList all available and loaded plugins'
        echo 'ls\tList all available and loaded plugins'
        echo 'install\tInstall a plugin from npm'
        echo 'uninstall\tUninstall a plugin'
        echo 'remove\tUninstall a plugin'
        echo 'create\tCreate a new plugin template'
        echo 'info\tShow detailed information about a plugin'
    else
        switch $subcmd[1]
            case 'list' 'ls'
                echo '--json\tOutput as JSON'
                echo '--help\tShow help for plugin list'
                echo '-h\tShow help for plugin list'
            case 'install'
                echo '--global\tInstall globally'
                echo '-g\tInstall globally'
                echo '--version\tInstall specific version'
                echo '--help\tShow help for plugin install'
                echo '-h\tShow help for plugin install'
            case 'uninstall' 'remove'
                echo '--global\tUninstall globally'
                echo '-g\tUninstall globally'
                echo '--help\tShow help for plugin uninstall'
                echo '-h\tShow help for plugin uninstall'
            case 'create'
                echo '--type\tPlugin type (function|class|npm)'
                echo '--dir\tOutput directory'
                echo '--help\tShow help for plugin create'
                echo '-h\tShow help for plugin create'
            case 'info'
                echo '--help\tShow help for plugin info'
                echo '-h\tShow help for plugin info'
        end
    end
end

# Complete upgrade command
function __{{ command_name | replace('-', '_') }}_complete_upgrade
    echo '--check\tCheck for updates without installing'
    echo '--version\tInstall specific version'
    echo '--pre\tInclude pre-release versions'
    echo '--dry-run\tShow what would be done without doing it'
    echo '--help\tShow help for upgrade command'
    echo '-h\tShow help for upgrade command'
end

# Helper function to check if we're completing an option value
function __{{ command_name | replace('-', '_') }}_completing_option
    set -l cmd (commandline -opc)
    if test (count $cmd) -gt 1
        switch $cmd[-1]
            case '--version' '--type' '--dir'
                return 0
        end
    end
    return 1
end

# Register completions
complete -c {{ command_name }} -f -a '(__{{ command_name | replace('-', '_') }}_complete)'

# Global options
{% for option in cli.options %}
complete -c {{ command_name }} -l {{ option.name }} -d '{{ option.desc }}'
{% if option.short %}
complete -c {{ command_name }} -s {{ option.short }} -d '{{ option.desc }}'
{% endif %}
{% endfor %}
complete -c {{ command_name }} -l help -s h -d 'Show help information'
complete -c {{ command_name }} -l version -s V -d 'Show version information'

# Command-specific completions with conditions
{% for cmd_name, cmd_data in cli.commands.items() %}
{% if cmd_data.options %}
{% for opt in cmd_data.options %}
complete -c {{ command_name }} -n '__fish_seen_subcommand_from {{ cmd_name }}' -l {{ opt.name }} -d '{{ opt.desc }}'
{% if opt.short %}
complete -c {{ command_name }} -n '__fish_seen_subcommand_from {{ cmd_name }}' -s {{ opt.short }} -d '{{ opt.desc }}'
{% endif %}
{% endfor %}
{% endif %}
{% endfor %}

# Plugin command specific options
complete -c {{ command_name }} -n '__fish_seen_subcommand_from plugin; and __fish_seen_subcommand_from list' -l json -d 'Output as JSON'
complete -c {{ command_name }} -n '__fish_seen_subcommand_from plugin; and __fish_seen_subcommand_from install' -l global -s g -d 'Install globally'
complete -c {{ command_name }} -n '__fish_seen_subcommand_from plugin; and __fish_seen_subcommand_from install' -l version -d 'Install specific version'
complete -c {{ command_name }} -n '__fish_seen_subcommand_from plugin; and __fish_seen_subcommand_from uninstall' -l global -s g -d 'Uninstall globally'
complete -c {{ command_name }} -n '__fish_seen_subcommand_from plugin; and __fish_seen_subcommand_from create' -l type -d 'Plugin type' -a 'function class npm'
complete -c {{ command_name }} -n '__fish_seen_subcommand_from plugin; and __fish_seen_subcommand_from create' -l dir -d 'Output directory' -a '(__fish_complete_directories)'

# Upgrade command options
complete -c {{ command_name }} -n '__fish_seen_subcommand_from upgrade' -l check -d 'Check for updates without installing'
complete -c {{ command_name }} -n '__fish_seen_subcommand_from upgrade' -l version -d 'Install specific version'
complete -c {{ command_name }} -n '__fish_seen_subcommand_from upgrade' -l pre -d 'Include pre-release versions'
complete -c {{ command_name }} -n '__fish_seen_subcommand_from upgrade' -l dry-run -d 'Show what would be done without doing it'

# File completion for certain options
complete -c {{ command_name }} -n '__fish_prev_arg_in --config --file -f' -a '(__fish_complete_path)'
complete -c {{ command_name }} -n '__fish_prev_arg_in --dir --directory -d' -a '(__fish_complete_directories)'