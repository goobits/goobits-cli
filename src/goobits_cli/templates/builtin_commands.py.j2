# Built-in commands for {{ display_name }}

def builtin_upgrade_command(check_only=False, pre=False, version=None, dry_run=False):
    """Built-in upgrade function for {{ display_name }}."""
    import subprocess
    import sys
    import shutil
    from pathlib import Path

    package_name = "{{ package_name }}"
    pypi_name = "{{ installation.pypi_name | default(package_name) }}"
    command_name = "{{ command_name }}"
    display_name = "{{ display_name }}"

    # Get current version
    try:
        from . import __version__
        current_version = __version__
    except Exception:
        current_version = "unknown"

    print(f"Current version: {current_version}")

    if check_only:
        print(f"Checking for updates to {display_name}...")
        try:
            import json
            import urllib.request
            import urllib.error
            from packaging import version
            
            # Check PyPI for latest version
            url = f"https://pypi.org/pypi/{{ package_name }}/json"
            with urllib.request.urlopen(url, timeout=10) as response:
                data = json.loads(response.read().decode())
                latest_version = data['info']['version']
                
            if version.parse(latest_version) > version.parse(current_version):
                print(f"üì¶ Update available: {current_version} ‚Üí {latest_version}")
                print(f"Run 'goobits upgrade {display_name.lower()}' or '{{ command_name }} upgrade' to update")
            else:
                print(f"‚úÖ You have the latest version ({current_version})")
                
        except (urllib.error.URLError, json.JSONDecodeError, KeyError, ImportError) as e:
            print(f"‚ö†Ô∏è  Could not check for updates: {e}")
            print("Run without --check to upgrade anyway")
        return

    # Try to detect installation method
    use_pipx = False
    if shutil.which("pipx"):
        # Check if installed via pipx
        result = subprocess.run(["pipx", "list"], capture_output=True, text=True)
        if package_name in result.stdout or pypi_name in result.stdout:
            use_pipx = True

    # Build the upgrade command
    if use_pipx:
        print(f"Upgrading {display_name} with pipx...")
        if version:
            cmd = ["pipx", "install", f"{pypi_name}=={version}", "--force"]
        else:
            cmd = ["pipx", "upgrade", pypi_name]
            if pre:
                cmd.extend(["--pip-args", "--pre"])
    else:
        print(f"Upgrading {display_name} with pip...")
        cmd = [sys.executable, "-m", "pip", "install", "--upgrade"]
        if version:
            cmd.append(f"{pypi_name}=={version}")
        else:
            cmd.append(pypi_name)
            if pre:
                cmd.append("--pre")

    if dry_run:
        print(f"Dry run - would execute: {' '.join(cmd)}")
        return

    # Execute upgrade
    print("Upgrading...")
    result = subprocess.run(cmd)

    if result.returncode == 0:
        print(f"‚úÖ {display_name} upgraded successfully!")
        print(f"Run '{command_name} --version' to verify the new version.")
    else:
        print(f"‚ùå Upgrade failed with exit code {result.returncode}")
        sys.exit(1)