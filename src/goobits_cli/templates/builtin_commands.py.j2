# Built-in commands for {{ display_name }}

def builtin_upgrade_command(check_only=False, pre=False, version=None, dry_run=False):
    """Built-in upgrade function for {{ display_name }}."""
    import subprocess
    import sys
    import shutil
    from pathlib import Path

    package_name = "{{ package_name }}"
    pypi_name = "{{ installation.pypi_name | default(package_name) }}"
    command_name = "{{ command_name }}"
    display_name = "{{ display_name }}"

    # Get current version
    try:
        from . import __version__
        current_version = __version__
    except:
        current_version = "unknown"

    print(f"Current version: {current_version}")

    if check_only:
        print(f"Checking for updates to {display_name}...")
        # TODO: Implement PyPI version check
        print("Update check not yet implemented. Run without --check to upgrade.")
        return

    # Try to detect installation method
    use_pipx = False
    if shutil.which("pipx"):
        # Check if installed via pipx
        result = subprocess.run(["pipx", "list"], capture_output=True, text=True)
        if package_name in result.stdout or pypi_name in result.stdout:
            use_pipx = True

    # Build the upgrade command
    if use_pipx:
        print(f"Upgrading {display_name} with pipx...")
        if version:
            cmd = ["pipx", "install", f"{pypi_name}=={version}", "--force"]
        else:
            cmd = ["pipx", "upgrade", pypi_name]
            if pre:
                cmd.extend(["--pip-args", "--pre"])
    else:
        print(f"Upgrading {display_name} with pip...")
        cmd = [sys.executable, "-m", "pip", "install", "--upgrade"]
        if version:
            cmd.append(f"{pypi_name}=={version}")
        else:
            cmd.append(pypi_name)
            if pre:
                cmd.append("--pre")

    if dry_run:
        print(f"Dry run - would execute: {' '.join(cmd)}")
        return

    # Execute upgrade
    print("Upgrading...")
    result = subprocess.run(cmd)

    if result.returncode == 0:
        print(f"✅ {display_name} upgraded successfully!")
        print(f"Run '{command_name} --version' to verify the new version.")
    else:
        print(f"❌ Upgrade failed with exit code {result.returncode}")
        sys.exit(1)