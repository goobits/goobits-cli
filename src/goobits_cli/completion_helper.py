"""
Shell completion helpers for Goobits CLI Framework
Generated by goobits-cli
"""

import os
import sys
from pathlib import Path
from typing import Dict, List, Optional


class CompletionHelper:
    """Helper class for generating shell completions"""
    
    def __init__(self, cli_name: str = "goobits-cli"):
        self.cli_name = cli_name
        self.script_name = cli_name
    
    def generate_bash_completion(self) -> str:
        """Generate bash completion script"""
        completion_func = self.cli_name.replace("-", "_")
        
        return f"""#!/bin/bash
# Bash completion script for {self.cli_name}
# Generated by goobits-cli

_{completion_func}_completion() {{
    local cur prev opts
    COMPREPLY=()
    cur="${{COMP_WORDS[COMP_CWORD]}}"
    prev="${{COMP_WORDS[COMP_CWORD-1]}}"
    
    # Get available commands
    if [[ ${{COMP_CWORD}} -eq 1 ]]; then
        # Top-level commands
        opts="$({self.script_name} --help 2>/dev/null | grep -E '^  [a-z]' | awk '{{print $1}}' | tr '\\n' ' ')"
        opts="$opts --help --version"
    else
        # Subcommands and options
        case "${{COMP_WORDS[1]}}" in
            *)
                opts="--help"
                ;;
        esac
    fi
    
    COMPREPLY=( $(compgen -W "${{opts}}" -- "${{cur}}") )
    return 0
}}

complete -F _{completion_func}_completion {self.script_name}
"""
        
    
    def generate_zsh_completion(self) -> str:
        """Generate zsh completion script"""
        completion_func = self.cli_name.replace("-", "_")
        
        return f"""#compdef {self.script_name}
# Zsh completion script for {self.cli_name}
# Generated by goobits-cli

_{completion_func}() {{
    local context state line
    typeset -A opt_args
    
    _arguments -s -S \\
        '(--help -h){{--help,-h}}[Show help message]' \\
        '(--version -V){{--version,-V}}[Show version]' \\
        '1: :->commands' \\
        '*:: :->args' && return 0
    
    case $state in
        (commands)
            local commands
            commands=(
                'help:Show help message'
                'completion:Shell completion management'
                'config:Configuration management'
            )
            _describe 'commands' commands
            ;;
        (args)
            case $words[1] in
                (help|completion|config)
                    _arguments -s -S \\
                        '(--help -h){{--help,-h}}[Show help message]'
                    ;;
            esac
            ;;
    esac
}}

_{completion_func} "$@"
"""
        
    
    def generate_fish_completion(self) -> str:
        """Generate fish completion script"""
        
        return f'''# Fish completion script for {self.cli_name}
# Generated by goobits-cli

# Complete main commands
complete -c {self.script_name} -n '__fish_use_subcommand' -a 'help' -d 'Show help message'
complete -c {self.script_name} -n '__fish_use_subcommand' -a 'completion' -d 'Shell completion management'
complete -c {self.script_name} -n '__fish_use_subcommand' -a 'config' -d 'Configuration management'

# Completion subcommands
complete -c {self.script_name} -n '__fish_seen_subcommand_from completion' -a 'generate' -d 'Generate completion script'
complete -c {self.script_name} -n '__fish_seen_subcommand_from completion' -a 'install' -d 'Install completion script'
complete -c {self.script_name} -n '__fish_seen_subcommand_from completion' -a 'instructions' -d 'Show installation instructions'

# Config subcommands
complete -c {self.script_name} -n '__fish_seen_subcommand_from config' -a 'get' -d 'Get configuration value'
complete -c {self.script_name} -n '__fish_seen_subcommand_from config' -a 'set' -d 'Set configuration value'
complete -c {self.script_name} -n '__fish_seen_subcommand_from config' -a 'reset' -d 'Reset configuration to defaults'
complete -c {self.script_name} -n '__fish_seen_subcommand_from config' -a 'path' -d 'Show configuration file path'

# Global options
complete -c {self.script_name} -s h -l help -d 'Show help message'
complete -c {self.script_name} -s V -l version -d 'Show version'
'''
        
    
    def get_completion_install_instructions(self, shell: str) -> Dict[str, str]:
        """Get installation instructions for completion scripts"""
        
        instructions = {
            'bash': {
                'script_path': f'/etc/bash_completion.d/{self.cli_name}',
                'user_script_path': f'~/.local/share/bash-completion/completions/{self.cli_name}',
                'install_cmd': f'sudo cp completion-script.bash /etc/bash_completion.d/{self.cli_name}',
                'user_install_cmd': f'mkdir -p ~/.local/share/bash-completion/completions && cp completion-script.bash ~/.local/share/bash-completion/completions/{self.cli_name}',
                'reload_cmd': 'source ~/.bashrc',
            },
            'zsh': {
                'script_path': f'/usr/share/zsh/site-functions/_{self.cli_name}',
                'user_script_path': f'~/.local/share/zsh/site-functions/_{self.cli_name}',
                'install_cmd': f'sudo cp completion-script.zsh /usr/share/zsh/site-functions/_{self.cli_name}',
                'user_install_cmd': f'mkdir -p ~/.local/share/zsh/site-functions && cp completion-script.zsh ~/.local/share/zsh/site-functions/_{self.cli_name}',
                'reload_cmd': 'exec zsh',
            },
            'fish': {
                'script_path': f'/usr/share/fish/completions/{self.cli_name}.fish',
                'user_script_path': f'~/.config/fish/completions/{self.cli_name}.fish',
                'install_cmd': f'sudo cp completion-script.fish /usr/share/fish/completions/{self.cli_name}.fish',
                'user_install_cmd': f'mkdir -p ~/.config/fish/completions && cp completion-script.fish ~/.config/fish/completions/{self.cli_name}.fish',
                'reload_cmd': 'No reload needed - fish will auto-detect',
            }
        }
        
        
        return instructions.get(shell, {})
    
    def save_completion_script(self, shell: str, output_dir: Optional[Path] = None) -> Path:
        """Save completion script to file"""
        if output_dir is None:
            output_dir = Path.cwd()
        
        generators = {
            'bash': self.generate_bash_completion,
            'zsh': self.generate_zsh_completion,
            'fish': self.generate_fish_completion,
        }
        
        if shell not in generators:
            
            raise ValueError(f"Unsupported shell: {shell}. Supported: {list(generators.keys())}")
            
        
        script_content = generators[shell]()
        
        script_file = output_dir / f"{self.cli_name}-completion.{shell}"
        
        
        script_file.write_text(script_content)
        return script_file
    
    def install_completion(self, shell: str, user_install: bool = True) -> bool:
        """Install completion script for the specified shell"""
        try:
            
            script_content = getattr(self, f'generate_{shell}_completion')()
            
            instructions = self.get_completion_install_instructions(shell)
            
            if user_install:
                script_path = Path(instructions['user_script_path']).expanduser()
            else:
                script_path = Path(instructions['script_path'])
            
            # Create directory if it doesn't exist
            script_path.parent.mkdir(parents=True, exist_ok=True)
            
            # Write the completion script
            script_path.write_text(script_content)
            
            return True
            
        except Exception as e:
            
            print(f"Error installing completion for {shell}: {e}")
            
            return False


def get_completion_helper() -> CompletionHelper:
    """Get a completion helper instance"""
    return CompletionHelper()


def generate_completion_script(shell: str) -> str:
    """Generate completion script for the specified shell"""
    helper = get_completion_helper()
    generators = {
        'bash': helper.generate_bash_completion,
        'zsh': helper.generate_zsh_completion,
        'fish': helper.generate_fish_completion,
    }
    
    if shell not in generators:
        
        raise ValueError(f"Unsupported shell: {shell}. Supported: {list(generators.keys())}")
        
    
    return generators[shell]()


def install_completion(shell: str, user_install: bool = True) -> bool:
    """Install completion script for the specified shell"""
    return get_completion_helper().install_completion(shell, user_install)


def get_install_instructions(shell: str) -> Dict[str, str]:
    """Get installation instructions for completion scripts"""
    return get_completion_helper().get_completion_install_instructions(shell)