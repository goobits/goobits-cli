"""
Python Help Formatter Generator

Generates a custom Click HelpFormatter class that produces unified help output.
The generated code uses rich-click for enhanced terminal UI while maintaining
consistent formatting across all languages.
"""

from typing import Any, Dict

from .spec import DEFAULT_FORMAT, HelpFormatSpec


class PythonHelpFormatter:
    """
    Generates Python code for a custom Click HelpFormatter.

    The generated formatter overrides Click's default help output to produce
    consistent formatting that matches other languages (Node.js, Rust, etc.).
    """

    def __init__(self, spec: HelpFormatSpec = DEFAULT_FORMAT):
        self.spec = spec

    def generate_formatter_class(self) -> str:
        """Generate the complete Python HelpFormatter class code."""
        return f'''
class GoobitsHelpFormatter(click.HelpFormatter):
    """
    Custom help formatter for unified output across all languages.
    Auto-generated by Goobits CLI Framework.
    """

    COMMAND_COL_WIDTH = {self.spec.layout.command_column_width}
    OPTION_COL_WIDTH = {self.spec.layout.option_column_width}
    MAX_WIDTH = {self.spec.layout.max_content_width}

    def __init__(self, *args, **kwargs):
        kwargs.setdefault("max_width", self.MAX_WIDTH)
        super().__init__(*args, **kwargs)

    def write_usage(self, prog: str, args: str = "", prefix: str = None) -> None:
        """Write unified usage line."""
        prefix = "{self.spec.usage_header}:\\n    "
        super().write_usage(prog, args, prefix=prefix)

    def write_heading(self, heading: str) -> None:
        """Write section heading in unified format."""
        self.write(f"\\n{{heading.upper()}}:\\n")

    def write_dl(self, rows, col_max: int = None, col_spacing: int = 2) -> None:
        """Write definition list with unified alignment."""
        col_max = col_max or self.OPTION_COL_WIDTH
        super().write_dl(rows, col_max=col_max, col_spacing=col_spacing)


class GoobitsGroup(RichGroup):
    """Custom group with unified help formatting."""

    def format_help(self, ctx, formatter):
        """Format help with version header."""
        self.format_usage(ctx, formatter)
        self.format_help_text(ctx, formatter)
        self.format_options(ctx, formatter)
        self.format_commands(ctx, formatter)
        self.format_epilog(ctx, formatter)

    def format_usage(self, ctx, formatter):
        """Format usage section."""
        formatter.write(f"{{ctx.info_name}} v{{ctx.obj.get(\'version\', \'0.0.0\') if ctx.obj else \'0.0.0\'}}\\n\\n")
        if self.help:
            formatter.write(f"{{self.help}}\\n\\n")
        pieces = self.collect_usage_pieces(ctx)
        formatter.write_usage(ctx.info_name, " ".join(pieces))

    def format_commands(self, ctx, formatter):
        """Format commands section with unified styling."""
        commands = []
        for subcommand in self.list_commands(ctx):
            cmd = self.get_command(ctx, subcommand)
            if cmd is None or cmd.hidden:
                continue
            help_text = cmd.get_short_help_str(limit=formatter.width)
            commands.append((subcommand, help_text))

        if commands:
            formatter.write_heading("{self.spec.commands_header}")
            formatter.write_dl(commands, col_max={self.spec.layout.command_column_width})


class GoobitsCommand(RichCommand):
    """Custom command with unified help formatting."""

    def format_help(self, ctx, formatter):
        """Format help with unified styling."""
        formatter.write(f"{{ctx.info_name}}\\n\\n")
        if self.help:
            formatter.write(f"{{self.help}}\\n\\n")
        self.format_usage(ctx, formatter)
        self.format_options(ctx, formatter)
        self.format_epilog(ctx, formatter)
'''

    def generate_imports(self) -> str:
        """Generate additional imports needed for the formatter."""
        return ""  # No additional imports needed beyond rich_click

    def generate_context_settings(self) -> Dict[str, Any]:
        """Generate Click context settings for unified behavior."""
        return {
            "help_option_names": [self.spec.help_short, self.spec.help_long],
            "max_content_width": self.spec.layout.max_content_width,
        }

    def get_group_class(self) -> str:
        """Return the name of the custom group class to use."""
        return "GoobitsGroup"

    def get_command_class(self) -> str:
        """Return the name of the custom command class to use."""
        return "GoobitsCommand"

    def generate_rich_click_config(self) -> str:
        """Generate rich-click configuration for unified styling."""
        return f"""
# Unified help styling configuration
click.rich_click.USE_RICH_MARKUP = True
click.rich_click.USE_MARKDOWN = False
click.rich_click.SHOW_ARGUMENTS = True
click.rich_click.GROUP_ARGUMENTS_OPTIONS = True
click.rich_click.STYLE_OPTION = "{self.spec.colors.option}"
click.rich_click.STYLE_ARGUMENT = "{self.spec.colors.argument}"
click.rich_click.STYLE_COMMAND = "{self.spec.colors.command}"
click.rich_click.STYLE_HELPTEXT = ""
click.rich_click.MAX_WIDTH = {self.spec.layout.max_content_width}
click.rich_click.OPTIONS_PANEL_TITLE = "{self.spec.options_header}"
click.rich_click.ARGUMENTS_PANEL_TITLE = "{self.spec.arguments_header}"
click.rich_click.COMMANDS_PANEL_TITLE = "{self.spec.commands_header}"
"""

    def generate_full_code(self) -> str:
        """Generate all formatter-related code to embed in CLI."""
        parts = []
        parts.append(self.generate_rich_click_config())
        parts.append(self.generate_formatter_class())
        return "\n".join(parts)
