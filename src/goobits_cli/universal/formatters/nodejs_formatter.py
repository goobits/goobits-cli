"""
Node.js Help Formatter Generator

Generates Commander.js configureHelp() code that produces unified help output.
The generated code customizes Commander's help display while maintaining
consistent formatting across all languages.
"""

from .spec import DEFAULT_FORMAT, HelpFormatSpec


class NodeJSHelpFormatter:
    """
    Generates JavaScript code for Commander.js custom help formatting.

    The generated code uses Commander's configureHelp() to produce
    consistent formatting that matches other languages (Python, Rust, etc.).
    """

    def __init__(self, spec: HelpFormatSpec = DEFAULT_FORMAT):
        self.spec = spec

    def generate_help_config(self) -> str:
        """Generate the Commander.js configureHelp() configuration."""
        return f'''
// Unified help formatting configuration
// Auto-generated by Goobits CLI Framework
const HELP_CONFIG = {{
    COMMAND_COL_WIDTH: {self.spec.layout.command_column_width},
    OPTION_COL_WIDTH: {self.spec.layout.option_column_width},
    MAX_WIDTH: {self.spec.layout.max_content_width},
    INDENT: ' '.repeat({self.spec.layout.indent_size}),
}};

/**
 * Configure unified help output for Commander.js
 * @param {{Command}} program - The Commander program instance
 * @param {{string}} version - The CLI version
 */
function configureUnifiedHelp(program, version) {{
    program.configureHelp({{
        // Format the help output header
        formatHelp: (cmd, helper) => {{
            const name = cmd.name();
            const desc = cmd.description();

            let output = `${{name}} v${{version}}\\n\\n`;

            if (desc) {{
                output += `${{desc}}\\n\\n`;
            }}

            // Usage section
            output += `{self.spec.usage_header}:\\n`;
            output += `${{HELP_CONFIG.INDENT}}${{helper.commandUsage(cmd)}}\\n\\n`;

            // Arguments section
            const args = helper.visibleArguments(cmd);
            if (args.length > 0) {{
                output += `{self.spec.arguments_header}:\\n`;
                output += formatDefinitionList(args.map(arg => [
                    arg.name(),
                    arg.description || ''
                ]));
                output += '\\n';
            }}

            // Options section
            const opts = helper.visibleOptions(cmd);
            if (opts.length > 0) {{
                output += `{self.spec.options_header}:\\n`;
                output += formatDefinitionList(opts.map(opt => [
                    helper.optionTerm(opt),
                    helper.optionDescription(opt)
                ]));
                output += '\\n';
            }}

            // Commands section
            const cmds = helper.visibleCommands(cmd);
            if (cmds.length > 0) {{
                output += `{self.spec.commands_header}:\\n`;
                output += formatDefinitionList(cmds.map(sub => [
                    sub.name(),
                    helper.subcommandDescription(sub)
                ]));
                output += '\\n';
            }}

            return output;
        }},

        // Customize subcommand display
        subcommandTerm: (cmd) => {{
            return cmd.name();
        }},

        // Customize option display
        optionTerm: (option) => {{
            return option.flags;
        }},
    }});
}}

/**
 * Format a definition list with aligned columns
 * @param {{Array<[string, string]>}} items - Array of [term, description] pairs
 * @returns {{string}} Formatted definition list
 */
function formatDefinitionList(items) {{
    const maxTermWidth = Math.min(
        HELP_CONFIG.OPTION_COL_WIDTH,
        Math.max(...items.map(([term]) => term.length)) + 2
    );

    return items.map(([term, desc]) => {{
        const padding = ' '.repeat(Math.max(2, maxTermWidth - term.length));
        return `${{HELP_CONFIG.INDENT}}${{term}}${{padding}}${{desc}}`;
    }}).join('\\n');
}}
'''

    def generate_version_handler(self) -> str:
        """Generate unified version output handler."""
        return '''
/**
 * Configure unified version output
 * @param {Command} program - The Commander program instance
 * @param {string} version - The CLI version
 */
function configureUnifiedVersion(program, version) {
    program.version(version, '-V, --version', 'Show version information');
}
'''

    def generate_error_handler(self) -> str:
        """Generate unified error output handler."""
        return f'''
/**
 * Configure unified error output
 * @param {{Command}} program - The Commander program instance
 */
function configureUnifiedErrors(program) {{
    program.showHelpAfterError(true);
    program.configureOutput({{
        writeErr: (str) => process.stderr.write(str),
        outputError: (str, write) => {{
            write(`\\x1b[{31}m${{str}}\\x1b[0m`);  // Red color for errors
        }}
    }});
}}
'''

    def generate_full_code(self) -> str:
        """Generate all formatter-related code to embed in CLI."""
        parts = [
            self.generate_help_config(),
            self.generate_version_handler(),
            self.generate_error_handler(),
        ]
        return "\n".join(parts)

    def generate_setup_call(self) -> str:
        """Generate the setup call to invoke in the main program."""
        return '''
// Apply unified help formatting
configureUnifiedHelp(program, VERSION);
configureUnifiedVersion(program, VERSION);
configureUnifiedErrors(program);
'''
