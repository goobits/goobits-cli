"""
Rust Help Formatter Generator

Generates Clap help_template! and styles configuration that produces unified
help output. The generated code customizes Clap's help display while maintaining
consistent formatting across all languages.
"""

from .spec import DEFAULT_FORMAT, HelpFormatSpec


class RustHelpFormatter:
    """
    Generates Rust code for Clap custom help formatting.

    The generated code uses Clap's help_template and styling system
    to produce consistent formatting that matches other languages.
    """

    def __init__(self, spec: HelpFormatSpec = DEFAULT_FORMAT):
        self.spec = spec

    def generate_help_template(self) -> str:
        """Generate the Clap help_template string."""
        # Clap uses special placeholders like {name}, {version}, {about}, etc.
        return f"""
/// Unified help template for consistent output across all languages.
/// Auto-generated by Goobits CLI Framework.
pub const HELP_TEMPLATE: &str = "\\
{{name}} v{{version}}

{{about}}

{self.spec.usage_header}:
    {{usage}}

{self.spec.arguments_header}:
{{positionals}}

{self.spec.options_header}:
{{options}}

{self.spec.commands_header}:
{{subcommands}}
";

/// Help template for subcommands (without the commands section).
pub const SUBCOMMAND_HELP_TEMPLATE: &str = "\\
{{name}} v{{version}}

{{about}}

{self.spec.usage_header}:
    {{usage}}

{self.spec.arguments_header}:
{{positionals}}

{self.spec.options_header}:
{{options}}
";
"""

    def generate_styles(self) -> str:
        """Generate Clap styling configuration."""
        return """
use clap::builder::{Styles, styling::AnsiColor};

/// Unified styling for consistent colors across all languages.
pub fn unified_styles() -> Styles {
    Styles::styled()
        .header(AnsiColor::Yellow.on_default().bold())
        .usage(AnsiColor::Yellow.on_default().bold())
        .literal(AnsiColor::Cyan.on_default())
        .placeholder(AnsiColor::Green.on_default())
        .valid(AnsiColor::Green.on_default())
        .invalid(AnsiColor::Red.on_default())
        .error(AnsiColor::Red.on_default().bold())
}
"""

    def generate_command_builder(self) -> str:
        """Generate helper function to apply unified formatting to Commands."""
        return f"""
use clap::{{Command, Arg}};

/// Apply unified help formatting to a Command.
pub fn with_unified_help(cmd: Command) -> Command {{
    cmd.help_template(HELP_TEMPLATE)
        .styles(unified_styles())
        .max_term_width({self.spec.layout.max_content_width})
        .help_expected(true)
}}

/// Apply unified help formatting to a subcommand.
pub fn with_subcommand_help(cmd: Command) -> Command {{
    cmd.help_template(SUBCOMMAND_HELP_TEMPLATE)
        .styles(unified_styles())
        .max_term_width({self.spec.layout.max_content_width})
}}

/// Configure the standard help and version flags.
pub fn with_standard_flags(cmd: Command) -> Command {{
    cmd.arg(
        Arg::new("help")
            .short('h')
            .long("help")
            .help("{self.spec.help_description}")
            .action(clap::ArgAction::Help)
            .global(true)
    )
    .arg(
        Arg::new("version")
            .short('V')
            .long("version")
            .help("{self.spec.version_description}")
            .action(clap::ArgAction::Version)
            .global(true)
    )
    .disable_help_flag(true)
    .disable_version_flag(true)
}}
"""

    def generate_error_handler(self) -> str:
        """Generate unified error output handler."""
        return """
use std::io::Write;

/// Print an error message in unified format.
pub fn print_error(message: &str) {
    let mut stderr = std::io::stderr();
    writeln!(stderr, "\\x1b[31merror:\\x1b[0m {}", message).ok();
}

/// Print a warning message in unified format.
pub fn print_warning(message: &str) {
    let mut stderr = std::io::stderr();
    writeln!(stderr, "\\x1b[33mwarning:\\x1b[0m {}", message).ok();
}
"""

    def generate_full_code(self) -> str:
        """Generate all formatter-related code to embed in CLI."""
        parts = [
            "// Unified Help Formatting",
            "// Auto-generated by Goobits CLI Framework",
            "",
            self.generate_help_template(),
            self.generate_styles(),
            self.generate_command_builder(),
            self.generate_error_handler(),
        ]
        return "\n".join(parts)

    def generate_usage_example(self) -> str:
        """Generate example of how to use the unified formatting."""
        return """
// Example usage in main.rs:
//
// fn main() {
//     let cmd = Command::new("mycli")
//         .version("1.0.0")
//         .about("My awesome CLI tool");
//
//     let cmd = with_unified_help(cmd);
//     let cmd = with_standard_flags(cmd);
//
//     // Add subcommands with unified formatting
//     let cmd = cmd.subcommand(
//         with_subcommand_help(
//             Command::new("build")
//                 .about("Build the project")
//         )
//     );
//
//     let matches = cmd.get_matches();
//     // ... handle matches
// }
"""
