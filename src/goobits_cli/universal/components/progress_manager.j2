{# Universal Progress Manager Template
   
   This template generates progress indicators and visual feedback systems
   for any supported language. Provides consistent user experience with
   spinners, progress bars, and status messages.
   
   Variables expected:
   - language: Target language (python, nodejs, typescript)
   - project: Project metadata
#}

{%- if language == 'python' -%}
"""
Progress indicators and visual feedback for {{ project.name }}
Generated by Goobits CLI Framework using Universal Templates
"""

import sys
import time
import logging
from typing import Any, Callable, Optional, Union, Iterator
from contextlib import contextmanager

logger = logging.getLogger(__name__)

# Try to import rich for enhanced display
try:
    from rich.progress import (
        Progress, TaskID, BarColumn, TextColumn, TimeRemainingColumn,
        SpinnerColumn, MofNCompleteColumn, TimeElapsedColumn
    )
    from rich.console import Console
    from rich.spinner import Spinner
    HAS_RICH = True
except ImportError:
    HAS_RICH = False
    Progress = None
    TaskID = None


class ProgressManager:
    """Universal progress manager with rich fallbacks"""
    
    def __init__(self, console: Optional['Console'] = None):
        self._fallback_enabled = not HAS_RICH
        
        if HAS_RICH:
            try:
                self.console = console or Console()
            except Exception:
                self.console = None
                self._fallback_enabled = True
        else:
            self.console = None
    
    @contextmanager
    def spinner(self, text: str = "Processing...", spinner: str = "dots"):
        """Context manager for showing a spinner"""
        if self._fallback_enabled or not self.console:
            print(f"{text}", end="", flush=True)
            try:
                yield None
                print(" ✓")
            except Exception:
                print(" ✗")
                raise
            return
        
        try:
            with self.console.status(f"[bold blue]{text}") as status:
                try:
                    status.spinner = spinner
                except Exception:
                    pass  # Continue with default spinner
                yield status
        except Exception:
            print(f"{text}", end="", flush=True)
            try:
                yield None
                print(" ✓")
            except Exception as e:
                print(" ✗")
                raise e
    
    @contextmanager  
    def progress_bar(
        self,
        description: str = "Processing...",
        total: Optional[int] = None,
        show_time: bool = True,
        show_percentage: bool = True
    ):
        """Context manager for showing a progress bar"""
        if self._fallback_enabled or not self.console:
            print(f"{description}")
            
            class FallbackProgress:
                def __init__(self):
                    self.total = total or 100
                    self.completed = 0
                    self.last_percentage = -1
                
                def update(self, task_id, advance: int = 1):
                    self.completed += advance
                    if self.total > 0:
                        pct = min(100, (self.completed / self.total) * 100)
                        if int(pct) != self.last_percentage:
                            print(f"\rProgress: {pct:.1f}%", end="", flush=True)
                            self.last_percentage = int(pct)
                
                def add_task(self, description: str, total: Optional[int] = None):
                    return "fallback_task"
            
            progress = FallbackProgress()
            try:
                yield progress, "fallback_task"
            finally:
                print()  # New line
            return
        
        try:
            columns = [
                TextColumn("[bold blue]{task.description}"),
                SpinnerColumn(),
                BarColumn(),
            ]
            
            if show_percentage:
                columns.append(TextColumn("[progress.percentage]{task.percentage:>3.0f}%"))
            
            if total is not None:
                columns.append(MofNCompleteColumn())
            
            if show_time:
                columns.extend([TimeElapsedColumn(), TimeRemainingColumn()])
            
            with Progress(*columns, console=self.console) as progress:
                task_id = progress.add_task(description, total=total)
                yield progress, task_id
                
        except Exception:
            # Fallback implementation
            print(f"{description}")
            
            class FallbackProgress:
                def __init__(self):
                    self.total = total or 100
                    self.completed = 0
                
                def update(self, task_id, advance: int = 1):
                    self.completed += advance
                    if self.total > 0:
                        pct = (self.completed / self.total) * 100
                        print(f"\rProgress: {pct:.1f}%", end="", flush=True)
                
                def add_task(self, description: str, total: Optional[int] = None):
                    return "fallback_task"
            
            progress = FallbackProgress()
            try:
                yield progress, "fallback_task"
            finally:
                print()
    
    def print_success(self, message: str):
        """Print a success message"""
        if not self._fallback_enabled and self.console:
            try:
                self.console.print(f"[bold green]✓[/bold green] {message}")
                return
            except Exception:
                pass
        print(f"✓ {message}")
    
    def print_error(self, message: str):
        """Print an error message"""
        if not self._fallback_enabled and self.console:
            try:
                self.console.print(f"[bold red]✗[/bold red] {message}", err=True)
                return
            except Exception:
                pass
        print(f"✗ {message}", file=sys.stderr)
    
    def print_warning(self, message: str):
        """Print a warning message"""
        if not self._fallback_enabled and self.console:
            try:
                self.console.print(f"[bold yellow]⚠[/bold yellow] {message}")
                return
            except Exception:
                pass
        print(f"⚠ {message}")
    
    def print_info(self, message: str):
        """Print an info message"""
        if not self._fallback_enabled and self.console:
            try:
                self.console.print(f"[bold blue]ℹ[/bold blue] {message}")
                return
            except Exception:
                pass
        print(f"ℹ {message}")


# Global instance
_progress_manager = None

def get_progress_manager() -> ProgressManager:
    """Get the global progress manager instance"""
    global _progress_manager
    if _progress_manager is None:
        _progress_manager = ProgressManager()
    return _progress_manager

# Convenience functions
def spinner(text: str = "Processing...", spinner: str = "dots"):
    """Get a spinner context manager"""
    return get_progress_manager().spinner(text, spinner)

def progress_bar(description: str = "Processing...", total: Optional[int] = None):
    """Get a progress bar context manager"""
    return get_progress_manager().progress_bar(description, total)

def print_success(message: str):
    """Print a success message"""
    get_progress_manager().print_success(message)

def print_error(message: str):
    """Print an error message"""
    get_progress_manager().print_error(message)

def print_warning(message: str):
    """Print a warning message"""
    get_progress_manager().print_warning(message)

def print_info(message: str):
    """Print an info message"""
    get_progress_manager().print_info(message)

{%- elif language == 'nodejs' -%}
/**
 * Progress indicators and visual feedback for {{ project.name }}
 * Generated by Goobits CLI Framework using Universal Templates
 */

const { performance } = require('perf_hooks');

// Try to import chalk for colors
let chalk;
try {
    chalk = require('chalk');
} catch (error) {
    // Fallback chalk implementation
    chalk = {
        green: (text) => text,
        red: (text) => text,
        yellow: (text) => text,
        blue: (text) => text,
        bold: (text) => text
    };
}

class ProgressManager {
    constructor() {
        this.spinnerFrames = ['⠋', '⠙', '⠹', '⠸', '⠼', '⠴', '⠦', '⠧', '⠇', '⠏'];
        this.currentFrame = 0;
    }

    async spinner(text = 'Processing...', operation) {
        const spinnerInterval = setInterval(() => {
            process.stdout.write(`\r${this.spinnerFrames[this.currentFrame]} ${text}`);
            this.currentFrame = (this.currentFrame + 1) % this.spinnerFrames.length;
        }, 100);

        try {
            const result = await operation();
            clearInterval(spinnerInterval);
            process.stdout.write(`\r✓ ${text}\n`);
            return result;
        } catch (error) {
            clearInterval(spinnerInterval);
            process.stdout.write(`\r✗ ${text}\n`);
            throw error;
        }
    }

    async progressBar(description = 'Processing...', total = 100, operation) {
        let current = 0;
        console.log(description);

        const updateProgress = (advance = 1) => {
            current += advance;
            const percentage = Math.min(100, (current / total) * 100);
            const barLength = 40;
            const filledLength = Math.floor((percentage / 100) * barLength);
            const bar = '█'.repeat(filledLength) + '░'.repeat(barLength - filledLength);
            process.stdout.write(`\r[${bar}] ${percentage.toFixed(1)}%`);
        };

        try {
            const result = await operation(updateProgress);
            process.stdout.write('\n');
            return result;
        } catch (error) {
            process.stdout.write(' ✗\n');
            throw error;
        }
    }

    printSuccess(message) {
        console.log(chalk.green('✓') + ' ' + message);
    }

    printError(message) {
        console.error(chalk.red('✗') + ' ' + message);
    }

    printWarning(message) {
        console.log(chalk.yellow('⚠') + ' ' + message);
    }

    printInfo(message) {
        console.log(chalk.blue('ℹ') + ' ' + message);
    }
}

// Global instance
let _progressManager = null;

function getProgressManager() {
    if (!_progressManager) {
        _progressManager = new ProgressManager();
    }
    return _progressManager;
}

// Convenience functions
async function spinner(text = 'Processing...', operation) {
    return getProgressManager().spinner(text, operation);
}

async function progressBar(description = 'Processing...', total = 100, operation) {
    return getProgressManager().progressBar(description, total, operation);
}

function printSuccess(message) {
    getProgressManager().printSuccess(message);
}

function printError(message) {
    getProgressManager().printError(message);
}

function printWarning(message) {
    getProgressManager().printWarning(message);
}

function printInfo(message) {
    getProgressManager().printInfo(message);
}

module.exports = {
    ProgressManager,
    getProgressManager,
    spinner,
    progressBar,
    printSuccess,
    printError,
    printWarning,
    printInfo
};

{%- elif language == 'typescript' -%}
/**
 * Progress indicators and visual feedback for {{ project.name }}
 * Generated by Goobits CLI Framework using Universal Templates
 */

import { performance } from 'perf_hooks';

// Try to import chalk for colors
let chalk: any;
try {
    chalk = require('chalk');
} catch (error) {
    // Fallback chalk implementation
    chalk = {
        green: (text: string) => text,
        red: (text: string) => text,
        yellow: (text: string) => text,
        blue: (text: string) => text,
        bold: (text: string) => text
    };
}

type ProgressCallback = (advance?: number) => void;
type ProgressOperation<T> = (updateProgress?: ProgressCallback) => Promise<T>;

export class ProgressManager {
    private spinnerFrames = ['⠋', '⠙', '⠹', '⠸', '⠼', '⠴', '⠦', '⠧', '⠇', '⠏'];
    private currentFrame = 0;

    public async spinner<T>(text: string = 'Processing...', operation: () => Promise<T>): Promise<T> {
        const spinnerInterval = setInterval(() => {
            process.stdout.write(`\r${this.spinnerFrames[this.currentFrame]} ${text}`);
            this.currentFrame = (this.currentFrame + 1) % this.spinnerFrames.length;
        }, 100);

        try {
            const result = await operation();
            clearInterval(spinnerInterval);
            process.stdout.write(`\r✓ ${text}\n`);
            return result;
        } catch (error) {
            clearInterval(spinnerInterval);
            process.stdout.write(`\r✗ ${text}\n`);
            throw error;
        }
    }

    public async progressBar<T>(
        description: string = 'Processing...',
        total: number = 100,
        operation: ProgressOperation<T>
    ): Promise<T> {
        let current = 0;
        console.log(description);

        const updateProgress = (advance: number = 1) => {
            current += advance;
            const percentage = Math.min(100, (current / total) * 100);
            const barLength = 40;
            const filledLength = Math.floor((percentage / 100) * barLength);
            const bar = '█'.repeat(filledLength) + '░'.repeat(barLength - filledLength);
            process.stdout.write(`\r[${bar}] ${percentage.toFixed(1)}%`);
        };

        try {
            const result = await operation(updateProgress);
            process.stdout.write('\n');
            return result;
        } catch (error) {
            process.stdout.write(' ✗\n');
            throw error;
        }
    }

    public printSuccess(message: string): void {
        console.log(chalk.green('✓') + ' ' + message);
    }

    public printError(message: string): void {
        console.error(chalk.red('✗') + ' ' + message);
    }

    public printWarning(message: string): void {
        console.log(chalk.yellow('⚠') + ' ' + message);
    }

    public printInfo(message: string): void {
        console.log(chalk.blue('ℹ') + ' ' + message);
    }
}

// Global instance
let _progressManager: ProgressManager | null = null;

export function getProgressManager(): ProgressManager {
    if (!_progressManager) {
        _progressManager = new ProgressManager();
    }
    return _progressManager;
}

// Convenience functions
export async function spinner<T>(text: string = 'Processing...', operation: () => Promise<T>): Promise<T> {
    return getProgressManager().spinner(text, operation);
}

export async function progressBar<T>(
    description: string = 'Processing...',
    total: number = 100,
    operation: ProgressOperation<T>
): Promise<T> {
    return getProgressManager().progressBar(description, total, operation);
}

export function printSuccess(message: string): void {
    getProgressManager().printSuccess(message);
}

export function printError(message: string): void {
    getProgressManager().printError(message);
}

export function printWarning(message: string): void {
    getProgressManager().printWarning(message);
}

export function printInfo(message: string): void {
    getProgressManager().printInfo(message);
}

{%- endif -%}