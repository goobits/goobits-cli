{#
Universal Component: Main entry file template for Node.js/TypeScript CLIs

This template generates the main entry file (index.js or cli.js) for Node.js
CLI applications using Commander.js framework.

Template Variables Expected:
  - project: Project configuration  
  - cli: CLI configuration
  - nodejs: Node.js specific context
#}
/**
 * {{ project.description }}
 * Generated by Goobits CLI Framework using Universal Templates
 * 
 * Entry point: {{ project.command_name }}
 */

import { Command } from 'commander';
import * as hooks from './src/hooks.js';

const program = new Command();

program
  .name('{{ project.command_name }}')
  .description('{{ cli.tagline | default(project.description) }}')
  .version('{{ project.version }}');

{%- if cli.root_command and cli.root_command.options %}
{%- for opt in cli.root_command.options %}
// Global option: {{ opt.name }}
program.option('{{ ("-" + opt.short + ", ") if opt.short else "" }}--{{ opt.name }}{{ " <value>" if opt.type != "flag" else "" }}', '{{ opt.description }}');
{%- endfor %}
{%- endif %}

{%- if cli.commands %}
{%- for cmd_name, cmd_data in cli.commands.items() %}

{%- if cmd_data.subcommands %}
// {{ cmd_name }} command group
const {{ cmd_name }}Command = program
  .command('{{ cmd_name }}')
  .description('{{ cmd_data.description }}');

{%- for subcmd in cmd_data.subcommands %}
// {{ cmd_name }} {{ subcmd.name }} subcommand
{{ cmd_name }}Command
  .command('{{ subcmd.name }}')
  .description('{{ subcmd.description }}')
  {%- if subcmd.arguments %}
  {%- for arg in subcmd.arguments %}
  .argument('{{ "<" + arg.name + ">" if arg.required else "[" + arg.name + "]" }}', '{{ arg.description }}')
  {%- endfor %}
  {%- endif %}
  {%- if subcmd.options %}
  {%- for opt in subcmd.options %}
  .option('{{ ("-" + opt.short + ", ") if opt.short else "" }}--{{ opt.name }}{{ " <value>" if opt.type != "flag" else "" }}', '{{ opt.description }}')
  {%- endfor %}
  {%- endif %}
  .action(async ({{ subcmd.arguments | map(attribute='name') | join(', ') }}{{ ', ' if subcmd.arguments }}options) => {
    const args = {
      commandName: '{{ cmd_name }}-{{ subcmd.name }}',
      rawArgs: options,
      {%- if subcmd.arguments %}
      {%- for arg in subcmd.arguments %}
      {{ arg.name }},
      {%- endfor %}
      {%- endif %}
    };
    
    try {
      const hookFunction = hooks.{{ ('on' + (subcmd.name.replace('-', '_') | title).replace('_', '')) }};
      if (hookFunction) {
        await hookFunction(args);
      } else {
        console.log(`No hook implementation found for command: ${args.commandName}`);
      }
    } catch (error) {
      console.error(`Error executing {{ cmd_name }} {{ subcmd.name }}:`, error.message);
      process.exit(1);
    }
  });
{%- endfor %}

{%- else %}
// {{ cmd_name }} command
program
  .command('{{ cmd_name }}')
  .description('{{ cmd_data.description }}')
  {%- if cmd_data.arguments %}
  {%- for arg in cmd_data.arguments %}
  .argument('{{ "<" + arg.name + ">" if arg.required else "[" + arg.name + "]" }}', '{{ arg.description }}')
  {%- endfor %}
  {%- endif %}
  {%- if cmd_data.options %}
  {%- for opt in cmd_data.options %}
  .option('{{ ("-" + opt.short + ", ") if opt.short else "" }}--{{ opt.name }}{{ " <value>" if opt.type != "flag" else "" }}', '{{ opt.description }}')
  {%- endfor %}
  {%- endif %}
  .action(async ({{ cmd_data.arguments | map(attribute='name') | join(', ') }}{{ ', ' if cmd_data.arguments }}options) => {
    const args = {
      commandName: '{{ cmd_name }}',
      rawArgs: options,
      {%- if cmd_data.arguments %}
      {%- for arg in cmd_data.arguments %}
      {{ arg.name }},
      {%- endfor %}
      {%- endif %}
    };
    
    try {
      const hookFunction = hooks.{{ ('on' + (cmd_name.replace('-', '_') | title).replace('_', '')) }};
      if (hookFunction) {
        await hookFunction(args);
      } else {
        console.log(`No hook implementation found for command: ${args.commandName}`);
      }
    } catch (error) {
      console.error(`Error executing {{ cmd_name }}:`, error.message);
      process.exit(1);
    }
  });
{%- endif %}
{%- endfor %}
{%- endif %}

// Main CLI function
export function cli() {
  program.parse(process.argv);
  
  // Show help if no command provided
  if (!process.argv.slice(2).length) {
    program.outputHelp();
  }
}

// Export for use as a module
export default cli;

// Auto-run if this is the main module
if (import.meta.url === `file://${process.argv[1]}`) {
  cli();
}