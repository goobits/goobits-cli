#!/bin/bash
# Setup script for {{ project.display_name | default(project.package_name) }}
# Generated by Goobits CLI Framework v{{ generator_version }}
#
# This script handles smart package.json merging and dependency installation

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Color

CLI_NAME="{{ cli.name }}"
DISPLAY_NAME="{{ project.display_name | default(project.package_name) }}"
CLI_VERSION="{{ project.version | default('1.0.0') }}"

echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${BLUE}   Setting up ${DISPLAY_NAME}${NC}"
echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo

# Check if Node.js is installed
if ! command -v node &> /dev/null; then
    echo -e "${RED}âŒ Error: Node.js is not installed${NC}"
    echo "Please install Node.js from https://nodejs.org/ (v18+ recommended)"
    exit 1
fi

# Check if npm is installed
if ! command -v npm &> /dev/null; then
    echo -e "${RED}âŒ Error: npm is not installed${NC}"
    echo "Please install npm (usually comes with Node.js)"
    exit 1
fi

NODE_VERSION=$(node --version | cut -d'v' -f2 | cut -d'.' -f1)
if [ "$NODE_VERSION" -lt 18 ]; then
    echo -e "${YELLOW}âš ï¸  Warning: Node.js v18+ is recommended (you have $(node --version))${NC}"
fi

echo -e "${GREEN}âœ… Node.js $(node --version) and npm $(npm --version) are installed${NC}"

# Smart package.json handling
if [ -f package.json ]; then
    echo -e "${BLUE}ðŸ“¦ Updating existing package.json...${NC}"
    
    # Backup existing package.json
    cp package.json package.json.backup.$(date +%Y%m%d_%H%M%S)
    
    # Check if package.json is valid JSON
    if ! npm pkg get name > /dev/null 2>&1; then
        echo -e "${YELLOW}âš ï¸  Warning: package.json appears to be malformed${NC}"
        echo -e "${YELLOW}   Creating backup and attempting repair...${NC}"
        mv package.json package.json.corrupted
        echo '{}' > package.json
    fi
    
    # Add type: module for ES6 support
    npm pkg set type=module 2>/dev/null || true
    
    # Add CLI to bin section
    npm pkg set "bin.${CLI_NAME}=./cli.mjs" 2>/dev/null || true
    
    # Add convenient npm script
    npm pkg set "scripts.${CLI_NAME}=node cli.mjs" 2>/dev/null || true
    
    # Ensure required dependencies are installed
    echo -e "${BLUE}ðŸ“¥ Installing required dependencies...${NC}"
    npm install --save commander@^12.0.0 chalk@^5.3.0 ora@^8.0.1 js-yaml@^4.1.0 winston@^3.11.0
    
    echo -e "${GREEN}âœ… Updated existing package.json successfully${NC}"
else
    echo -e "${BLUE}ðŸ“¦ Creating new package.json...${NC}"
    
    # Create a new package.json with minimal required fields
    cat > package.json << 'EOF'
{
  "name": "{{ cli.name }}",
  "version": "{{ project.version | default('1.0.0') }}",
  "description": "{{ project.description | default('CLI generated by Goobits') }}",
  "type": "module",
  "bin": {
    "{{ cli.name }}": "./cli.mjs"
  },
  "scripts": {
    "{{ cli.name }}": "node cli.mjs",
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "dependencies": {
    "commander": "^12.0.0",
    "chalk": "^5.3.0",
    "ora": "^8.0.1",
    "js-yaml": "^4.1.0",
    "winston": "^3.11.0"
  },
  "engines": {
    "node": ">=18.0.0"
  }
}
EOF
    
    echo -e "${BLUE}ðŸ“¥ Installing dependencies...${NC}"
    npm install
    
    echo -e "${GREEN}âœ… Created new package.json and installed dependencies${NC}"
fi

# Create hooks file if it doesn't exist
HOOKS_FILE="src/hooks.mjs"
if [ ! -f "$HOOKS_FILE" ]; then
    echo -e "${BLUE}ðŸ“ Creating hooks file template...${NC}"
    
    mkdir -p src
    cat > "$HOOKS_FILE" << 'EOF'
/**
 * Hook implementations for {{ project.display_name | default(project.package_name) }}
 * 
 * Each command in your CLI should have a corresponding hook function here.
 * The function name should be 'on' + CommandName (capitalized).
 */

{%- if cli.commands %}
  {%- for cmd_name, cmd_data in cli.commands.items() %}

/**
 * Hook for '{{ cmd_name }}' command
 * {%- if cmd_data.desc %}
 * {{ cmd_data.desc }}
 * {%- endif %}
 * 
 * @param {Object} args - Command arguments and options
 */
export async function on{{ cmd_name | capitalize }}(args) {
    console.log('{{ cmd_name }} command called with:', args);
    
    // TODO: Implement {{ cmd_name }} logic here
    throw new Error('{{ cmd_name }} command not yet implemented');
}

    {%- if cmd_data.subcommands %}
      {%- for sub_name, sub_data in cmd_data.subcommands.items() %}
/**
 * Hook for '{{ cmd_name }} {{ sub_name }}' subcommand
 * {%- if sub_data.desc %}
 * {{ sub_data.desc }}
 * {%- endif %}
 * 
 * @param {Object} args - Command arguments and options
 */
export async function on{{ cmd_name | capitalize }}{{ sub_name | capitalize }}(args) {
    console.log('{{ cmd_name }} {{ sub_name }} command called with:', args);
    
    // TODO: Implement {{ cmd_name }} {{ sub_name }} logic here
    throw new Error('{{ cmd_name }} {{ sub_name }} command not yet implemented');
}
      {%- endfor %}
    {%- endif %}
  {%- endfor %}
{%- elif cli.root_command and cli.root_command.subcommands %}
  {%- for command in cli.root_command.subcommands %}

/**
 * Hook for '{{ command.name }}' command
 * {%- if command.description %}
 * {{ command.description }}
 * {%- endif %}
 * 
 * @param {Object} args - Command arguments and options
 */
export async function on{{ command.name | capitalize }}(args) {
    console.log('{{ command.name }} command called with:', args);
    
    // TODO: Implement {{ command.name }} logic here
    throw new Error('{{ command.name }} command not yet implemented');
}
  {%- endfor %}
{%- endif %}

// Example of additional helper functions
function validateInput(input) {
    // Add validation logic
    return true;
}

async function processData(data) {
    // Add data processing logic
    return data;
}
EOF
    
    echo -e "${GREEN}âœ… Created ${HOOKS_FILE} with template implementations${NC}"
else
    echo -e "${GREEN}âœ… Hooks file already exists at ${HOOKS_FILE}${NC}"
fi

# Make the CLI executable
if [ -f cli.mjs ]; then
    chmod +x cli.mjs
    echo -e "${GREEN}âœ… Made cli.mjs executable${NC}"
fi

# Link the CLI globally (optional)
echo
echo -e "${BLUE}Would you like to link '${CLI_NAME}' globally? (y/n)${NC}"
read -r -n 1 response
echo
if [[ "$response" =~ ^[Yy]$ ]]; then
    echo -e "${BLUE}ðŸ”— Linking CLI globally...${NC}"
    
    if npm link; then
        echo -e "${GREEN}âœ… Successfully linked! You can now use '${CLI_NAME}' from anywhere.${NC}"
    else
        echo -e "${YELLOW}âš ï¸  Failed to link globally. You may need sudo permissions.${NC}"
        echo -e "${YELLOW}   Try: sudo npm link${NC}"
    fi
else
    echo -e "${BLUE}â„¹ï¸  To link later, run: npm link${NC}"
fi

# Final instructions
echo
echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${GREEN}   Setup complete! ðŸŽ‰${NC}"
echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo
echo -e "${BLUE}To get started:${NC}"
echo -e "  1. Run locally:    ${GREEN}node cli.mjs --help${NC}"
if npm ls -g --depth=0 2>/dev/null | grep -q "${CLI_NAME}"; then
    echo -e "  2. Run globally:   ${GREEN}${CLI_NAME} --help${NC}"
fi
echo -e "  3. Edit hooks:     ${GREEN}$EDITOR ${HOOKS_FILE}${NC}"
echo
echo -e "${BLUE}For more information, see the documentation.${NC}"