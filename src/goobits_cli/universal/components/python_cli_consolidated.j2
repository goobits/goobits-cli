#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
{{ project.name }} - {{ project.description }}
Generated by Goobits CLI Framework v{{ generator_version }}

This is a consolidated Python CLI file with all utilities embedded.
Generated from: {{ config_filename }}
"""

import sys
import os
import json
import yaml
import traceback
from pathlib import Path
from typing import Any, Dict, Optional, List, Union
from datetime import datetime
from contextlib import contextmanager
import rich_click as click

# Configure Rich-Click styling to prevent version fragmentation
click.rich_click.USE_RICH_MARKUP = True
click.rich_click.STYLE_USAGE_COMMAND = "bold bright_green"
click.rich_click.STYLE_USAGE = "white"
click.rich_click.STYLE_HEADER_TEXT = "cyan"
{%- if cli.features and cli.features.interactive_mode and cli.features.interactive_mode.enabled %}
from prompt_toolkit import prompt
from prompt_toolkit.completion import WordCompleter
{%- endif %}

# ============================================================================
# EMBEDDED LOGGER
# ============================================================================

class ColoredFormatter(__import__('logging').Formatter):
    """Custom formatter with color support."""
    
    COLORS = {
        'DEBUG': '\033[36m',    # Cyan
        'INFO': '\033[32m',     # Green
        'WARNING': '\033[33m',  # Yellow
        'ERROR': '\033[31m',    # Red
        'CRITICAL': '\033[35m', # Magenta
    }
    RESET = '\033[0m'
    
    def format(self, record):
        log_color = self.COLORS.get(record.levelname, self.RESET)
        record.levelname = f"{log_color}{record.levelname}{self.RESET}"
        return super().format(record)

def setup_logging(level=__import__('logging').INFO, log_file=None):
    """Configure logging for the CLI."""
    handlers = []
    
    # Console handler with colors
    logging = __import__('logging')
    console_handler = logging.StreamHandler()
    console_handler.setFormatter(ColoredFormatter(
        '%(asctime)s - %(levelname)s - %(message)s',
        datefmt='%Y-%m-%d %H:%M:%S'
    ))
    handlers.append(console_handler)
    
    # File handler if specified
    if log_file:
        file_handler = logging.FileHandler(log_file)
        file_handler.setFormatter(logging.Formatter(
            '%(asctime)s - %(levelname)s - %(name)s - %(message)s'
        ))
        handlers.append(file_handler)
    
    logging.basicConfig(
        level=level,
        handlers=handlers
    )

logger = __import__('logging').getLogger(__name__)

# ============================================================================
# EMBEDDED CONFIG MANAGER
# ============================================================================

class ConfigManager:
    """Manage CLI configuration."""
    
    def __init__(self, config_file: Optional[Path] = None):
        """Initialize configuration manager."""
        if config_file is None:
            config_dir = Path.home() / '.config' / '{{ cli.name | default(project.command_name) }}'
            config_dir.mkdir(parents=True, exist_ok=True)
            config_file = config_dir / 'config.yaml'
        
        self.config_file = Path(config_file)
        self.config = self._load_config()
    
    def _load_config(self) -> Dict[str, Any]:
        """Load configuration from file."""
        if self.config_file.exists():
            try:
                with open(self.config_file, 'r') as f:
                    return yaml.safe_load(f) or {}
            except Exception as e:
                logger.warning(f"Failed to load config: {e}")
                return {}
        return {}
    
    def save_config(self) -> bool:
        """Save configuration to file."""
        try:
            with open(self.config_file, 'w') as f:
                yaml.safe_dump(self.config, f, default_flow_style=False)
            return True
        except Exception as e:
            logger.error(f"Failed to save config: {e}")
            return False
    
    def get(self, key: str, default: Any = None) -> Any:
        """Get configuration value."""
        keys = key.split('.')
        value = self.config
        for k in keys:
            if isinstance(value, dict):
                value = value.get(k)
                if value is None:
                    return default
            else:
                return default
        return value
    
    def set(self, key: str, value: Any):
        """Set configuration value."""
        keys = key.split('.')
        config = self.config
        for k in keys[:-1]:
            if k not in config:
                config[k] = {}
            config = config[k]
        config[keys[-1]] = value

# ============================================================================
# EMBEDDED ERROR HANDLER
# ============================================================================

class CLIError(Exception):
    """Base exception for CLI errors."""
    exit_code = 1

class UsageError(CLIError):
    """Exception for usage errors."""
    exit_code = 2

class ConfigError(CLIError):
    """Exception for configuration errors."""
    exit_code = 3

def handle_error(error: Exception, verbose: bool = False):
    """Handle CLI errors consistently."""
    if isinstance(error, CLIError):
        logger.error(str(error))
        if verbose:
            logger.debug(traceback.format_exc())
        sys.exit(error.exit_code)
    else:
        logger.error(f"Unexpected error: {error}")
        if verbose:
            logger.debug(traceback.format_exc())
        else:
            logger.info("Run with --verbose for more details")
        sys.exit(1)

# ============================================================================
# CLI CONTEXT
# ============================================================================

class CLIContext:
    """Shared context for CLI commands."""
    
    def __init__(self, config: ConfigManager, verbose: bool = False, debug: bool = False):
        self.config = config
        self.verbose = verbose
        self.debug = debug
        
        # Setup logging based on verbosity
        logging = __import__('logging')
        if debug:
            setup_logging(logging.DEBUG)
        elif verbose:
            setup_logging(logging.INFO)
        else:
            setup_logging(logging.WARNING)

# ============================================================================
# HOOK SYSTEM
# ============================================================================

def load_hooks():
    """Load user-defined hooks."""
    try:
        import cli_hooks
        return cli_hooks
    except ImportError:
        # Check if this is self-hosting (framework building itself)
        try:
            from goobits_cli import main as goobits_main
            # If we can import main, this is the framework building itself - suppress warnings
            return None  
        except ImportError:
            # Only show warning if not in help mode
            if '--help' not in sys.argv and '-h' not in sys.argv:
                logger.warning("No cli_hooks.py found. Please create one with your command implementations.")
                logger.warning("Example:")
                logger.warning("  def on_{{ cli.commands | first | first }}(ctx, **kwargs):")
                logger.warning("      print('Command implementation')")
            return None

hooks = load_hooks()

# ============================================================================
# COLOR PROCESSING
# ============================================================================

def process_yaml_colors(text: str) -> str:
    """Process YAML color syntax for terminal display using Rich markup."""
    if not text:
        return text
    
    import re
    
    # Convert hex colors to rich markup
    # Dracula color palette
    dracula_colors = {
        '#f8f8f2': 'bright_white',    # Foreground (white)
        '#6272a4': 'white',           # Comment (lighter gray) 
        '#8be9fd': 'cyan',            # Cyan
        '#50fa7b': 'bright_green',    # Green
        '#ffb86c': 'orange',          # Orange
        '#ff79c6': 'magenta',         # Pink
        '#bd93f9': 'bright_magenta',  # Purple
        '#ff5555': 'bright_red',      # Red
        '#f1fa8c': 'yellow',          # Yellow
    }
    
    # Process hex color tags: [#ff79c6]text[/#ff79c6] -> [magenta]text[/magenta]
    def replace_hex_color(match):
        hex_color = '#' + match.group(1).lower()
        content = match.group(2)
        if hex_color in dracula_colors:
            rich_color = dracula_colors[hex_color]
            return f"[{rich_color}]{content}[/{rich_color}]"
        else:
            return content
    
    # Replace hex color tags with rich markup
    text = re.sub(r'\[#([0-9a-fA-F]{6})\]([^[\]]*)\[/#[0-9a-fA-F]{6}\]', replace_hex_color, text)
    
    # Process numbered color tags (legacy support)
    color_map = {
        '0': 'bright_white',    # White (foreground)
        '1': 'bright_red',      # Red
        '2': 'bright_green',    # Green 
        '3': 'yellow',          # Yellow
        '4': 'cyan',            # Cyan
        '5': 'bright_magenta',  # Purple
        '6': 'magenta',         # Pink
        '7': 'white',           # Comment (lighter gray)
    }
    
    def replace_numbered_color(match):
        color_num = match.group(1)
        content = match.group(2)
        if color_num in color_map:
            rich_color = color_map[color_num]
            return f"[{rich_color}]{content}[/{rich_color}]"
        else:
            return content
    
    # Replace numbered color tags: [color(2)]text[/color(2)] -> [bright_green]text[/bright_green]
    text = re.sub(r'\[color\((\d+)\)\]([^[\]]*)\[/color\(\d+\)\]', replace_numbered_color, text)
    
    return text

# ============================================================================
# CLI COMMANDS
# ============================================================================

@click.group(context_settings={'help_option_names': ['-h', '--help']})
@click.version_option(version='{{ cli.version | default(project.version) | default("1.0.0") }}', prog_name='{{ cli.name | default(project.command_name) }}')
{%- for option in cli.global_options | default([]) %}
@click.option('--{{ option.name }}'{% if option.short %}, '-{{ option.short }}'{% endif %}, is_flag=True, help='{{ option.desc | default(option.description) }}')
{%- endfor %}
@click.pass_context
def cli(ctx, verbose, debug, config):
    help_text = """{{ cli.tagline | default(cli.description) | default(project.description) | default('CLI Application') }}
{% if cli.header_sections %}

{% for section in cli.header_sections %}
{{ section.title }}
{% for item in section['items'] %}
   {{ item.item }} - {{ item.desc }}
{% endfor %}

{% endfor %}
{% endif %}
{% if cli.footer_note %}

{{ cli.footer_note }}
{% endif %}"""
    # Process colors in help text
    cli.__doc__ = process_yaml_colors(help_text)
    config_path = Path(config) if config else None
    config_manager = ConfigManager(config_path)
    ctx.obj = CLIContext(config_manager, verbose, debug)

{% if cli.commands %}
  {%- for cmd_name, cmd_data in cli.commands.items() %}

    {%- if not cmd_data.subcommands %}
@cli.command('{{ cmd_name }}')
{% for arg in cmd_data.args | default(cmd_data.arguments) | default([]) -%}
{%- if arg.required == false %}
@click.argument('{{ arg.name }}', type={{ 'click.INT' if arg.type == 'int' else 'click.STRING' }}, required=False, default='{{ arg.default | default("") }}'{% if arg.nargs and arg.nargs == "*" %}, nargs=-1{% endif %})
{%- else %}
@click.argument('{{ arg.name }}', type={{ 'click.INT' if arg.type == 'int' else 'click.STRING' }}{% if arg.nargs and arg.nargs == "*" %}, nargs=-1{% endif %})
{%- endif %}
{% endfor -%}
{% for opt in cmd_data.options | default([]) -%}
@click.option('--{{ opt.name }}'{% if opt.short %}, '-{{ opt.short }}'{% endif %}{% if opt.type == 'bool' %}, is_flag=True{% endif %}{% if opt.default is defined %}, default={{ opt.default | python_repr }}{% endif %}, help={{ (opt.desc | default(opt.description)) | python_repr }})
{% endfor %}
@click.pass_obj
def {{ cmd_name.replace('-', '_') }}(ctx{% for arg in cmd_data.args | default(cmd_data.arguments) | default([]) %}, {{ arg.name }}{% endfor %}{% for opt in cmd_data.options | default([]) %}, {{ opt.name.replace('-', '_') }}{% endfor %}):
    """{{ cmd_data.desc | default(cmd_data.description) }}"""
    try:
        # Check if this is self-hosting case  
        is_self_hosting = False
        try:
            from goobits_cli import main as goobits_main
            is_self_hosting = True
        except ImportError:
            pass
            
        if hooks and hasattr(hooks, 'on_{{ cmd_name.replace("-", "_") }}'):
            kwargs = {
                {%- for arg in cmd_data.args | default(cmd_data.arguments) | default([]) %}
                '{{ arg.name }}': {{ arg.name }},
                {% endfor -%}
                {%- for opt in cmd_data.options | default([]) %}
                '{{ opt.name.replace("-", "_") }}': {{ opt.name.replace('-', '_') }},
                {% endfor -%}
            }
            hooks.on_{{ cmd_name.replace("-", "_") }}(ctx=ctx, **kwargs)
        elif is_self_hosting:
            # Self-hosting: call main.py implementation directly
            from goobits_cli.main import {{ cmd_name.replace("-", "_") }} as main_{{ cmd_name.replace("-", "_") }}
            from pathlib import Path
            
            {% if cmd_name == 'build' %}
            # Handle build command arguments
            main_{{ cmd_name.replace("-", "_") }}(
                config_path=Path({{ cmd_data.args[0].name if cmd_data.args else 'config_path' }}) if {{ cmd_data.args[0].name if cmd_data.args else 'config_path' }} else None,
{%- for opt in cmd_data.options | default([]) %}
{%- if opt.name == 'output-dir' or opt.name == 'output_dir' %}
                output_dir=Path({{ opt.name.replace('-', '_') }}) if {{ opt.name.replace('-', '_') }} else None,
{%- elif opt.name == 'backup' %}
                backup=bool({{ opt.name.replace('-', '_') }}),
{%- else %}
                {{ opt.name.replace('-', '_') }}={{ opt.name.replace('-', '_') }},
{%- endif %}
{% endfor %}
            )
            {% else %}
            # Handle other commands - call with converted arguments
            main_{{ cmd_name.replace("-", "_") }}(
{%- for arg in cmd_data.args | default(cmd_data.arguments) | default([]) %}
                {{ arg.name }}={% if arg.type == 'path' %}Path({{ arg.name }}) if {{ arg.name }} else None{% else %}{{ arg.name }}{% endif %},
{% endfor -%}
{%- for opt in cmd_data.options | default([]) %}
                {{ opt.name.replace('-', '_') }}={{ opt.name.replace('-', '_') }},
{% endfor %}
            )
            {% endif %}
        else:
            logger.error(f"Hook 'on_{{ cmd_name.replace("-", "_") }}' not implemented in cli_hooks.py")
            sys.exit(1)
    except Exception as e:
        handle_error(e, ctx.verbose)
    {% endif %}

    {%- if cmd_data.subcommands %}
@cli.group('{{ cmd_name }}')
@click.pass_obj
def {{ cmd_name.replace('-', '_') }}_group(ctx):
    """{{ cmd_data.desc | default(cmd_data.description) }}"""
    pass

      {%- if cmd_data.subcommands is mapping %}
        {%- for sub_name, sub_data in cmd_data.subcommands.items() %}

@{{ cmd_name.replace('-', '_') }}_group.command('{{ sub_name }}')
          {%- for arg in (sub_data.arguments if sub_data is mapping else []) | default([]) %}
{%- if arg.required == false %}
@click.argument('{{ arg.name }}', type={{ 'click.INT' if arg.type == 'int' else 'click.STRING' }}, required=False, default='{{ arg.default | default("") }}'{% if arg.nargs and arg.nargs == "*" %}, nargs=-1{% endif %})
{%- else %}
@click.argument('{{ arg.name }}', type={{ 'click.INT' if arg.type == 'int' else 'click.STRING' }}{% if arg.nargs and arg.nargs == "*" %}, nargs=-1{% endif %})
{%- endif %}
          {%- endfor %}
          {%- for opt in (sub_data.options if sub_data is mapping else []) | default([]) %}
@click.option('--{{ opt.name }}'{% if opt.short %}, '-{{ opt.short }}'{% endif %}{%- if opt.type == 'bool' %}, is_flag=True{% endif %}{%- if opt.default is defined %}, default={{ opt.default | python_repr }}{% endif %}, help='{{ opt.description }}')
          {%- endfor %}
@click.pass_obj
def {{ cmd_name.replace('-', '_') }}_{{ sub_name.replace('-', '_') }}(ctx{% for arg in (sub_data.arguments if sub_data is mapping else []) | default([]) %}, {{ arg.name }}{% endfor %}{% for opt in (sub_data.options if sub_data is mapping else []) | default([]) %}, {{ opt.name.replace('-', '_') }}{% endfor %}):
    """{{ sub_data.desc if sub_data is mapping else sub_data if sub_data is string else '' }}"""
    try:
        if hooks and hasattr(hooks, 'on_{{ cmd_name.replace("-", "_") }}_{{ sub_name.replace("-", "_") }}'):
            kwargs = {
                {%- for arg in (sub_data.arguments if sub_data is mapping else []) | default([]) %}
                '{{ arg.name }}': {{ arg.name }},
                {%- endfor %}
                {%- for opt in (sub_data.options if sub_data is mapping else []) | default([]) %}
                '{{ opt.name.replace("-", "_") }}': {{ opt.name.replace('-', '_') }},
                {%- endfor %}
            }
            hooks.on_{{ cmd_name.replace("-", "_") }}_{{ sub_name.replace("-", "_") }}(ctx=ctx, **kwargs)
        else:
            logger.error(f"Hook 'on_{{ cmd_name.replace("-", "_") }}_{{ sub_name.replace("-", "_") }}' not implemented in cli_hooks.py")
            sys.exit(1)
    except Exception as e:
        handle_error(e, ctx.verbose)
        {%- endfor %}
      {%- else %}
        {%- for sub_data in cmd_data.subcommands %}

@{{ cmd_name.replace('-', '_') }}_group.command('{{ sub_data.name }}')
          {% for arg in sub_data.arguments | default([]) %}
{%- if arg.required == false %}
@click.argument('{{ arg.name }}', type={{ 'click.INT' if arg.type == 'int' else 'click.STRING' }}, required=False, default='{{ arg.default | default("") }}'{% if arg.nargs and arg.nargs == "*" %}, nargs=-1{% endif %})
{%- else %}
@click.argument('{{ arg.name }}', type={{ 'click.INT' if arg.type == 'int' else 'click.STRING' }}{% if arg.nargs and arg.nargs == "*" %}, nargs=-1{% endif %})
{%- endif %}
          {% endfor %}
          {% for opt in sub_data.options | default([]) %}
@click.option('--{{ opt.name }}'{% if opt.short %}, '-{{ opt.short }}'{% endif %}{%- if opt.type == 'bool' %}, is_flag=True{% endif %}{%- if opt.default is defined %}, default={{ opt.default | python_repr }}{% endif %}, help='{{ opt.description }}')
          {% endfor %}
@click.pass_obj
def {{ cmd_name.replace('-', '_') }}_{{ sub_data.name.replace('-', '_') }}(ctx{% for arg in sub_data.arguments | default([]) %}, {{ arg.name }}{% endfor %}{% for opt in sub_data.options | default([]) %}, {{ opt.name.replace('-', '_') }}{% endfor %}):
    """{{ sub_data.description }}"""
    try:
        if hooks and hasattr(hooks, '{{ sub_data.hook_name }}'):
            kwargs = {
                {%- for arg in sub_data.arguments | default([]) %}
                '{{ arg.name }}': {{ arg.name }},
                {%- endfor %}
                {%- for opt in sub_data.options | default([]) %}
                '{{ opt.name.replace("-", "_") }}': {{ opt.name.replace('-', '_') }},
                {%- endfor %}
            }
            hooks.{{ sub_data.hook_name }}(ctx=ctx, **kwargs)
        else:
            logger.error(f"Hook '{{ sub_data.hook_name }}' not implemented in cli_hooks.py")
            sys.exit(1)
    except Exception as e:
        handle_error(e, ctx.verbose)
        {% endfor %}
      {% endif %}
    {% endif %}
  {% endfor %}
{%- elif cli.root_command and cli.root_command.subcommands %}
  {%- for command in cli.root_command.subcommands %}

@cli.command('{{ command.name }}')
    {%- for arg in command.arguments | default([]) %}
{%- if arg.required == false %}
@click.argument('{{ arg.name }}', type={{ 'click.INT' if arg.type == 'int' else 'click.STRING' }}, required=False, default='{{ arg.default | default("") }}'{% if arg.nargs and arg.nargs == "*" %}, nargs=-1{% endif %})
{%- else %}
@click.argument('{{ arg.name }}', type={{ 'click.INT' if arg.type == 'int' else 'click.STRING' }}{% if arg.nargs and arg.nargs == "*" %}, nargs=-1{% endif %})
{%- endif %}
    {%- endfor %}
    {%- for opt in command.options | default([]) %}
@click.option('--{{ opt.name }}'{% if opt.short %}, '-{{ opt.short }}'{% endif %}{%- if opt.type == 'bool' %}, is_flag=True{% endif %}{%- if opt.default is defined %}, default={{ opt.default | python_repr }}{% endif %}, help='{{ opt.description }}')
    {%- endfor %}
@click.pass_obj
def {{ command.name.replace('-', '_') }}(ctx{% for arg in command.arguments | default([]) %}, {{ arg.name }}{% endfor %}{% for opt in command.options | default([]) %}, {{ opt.name.replace('-', '_') }}{% endfor %}):
    """{{ command.description }}"""
    try:
        if hooks and hasattr(hooks, 'on_{{ command.name.replace("-", "_") }}'):
            kwargs = {
                {%- for arg in command.arguments | default([]) %}
                '{{ arg.name }}': {{ arg.name }},
                {%- endfor %}
                {%- for opt in command.options | default([]) %}
                '{{ opt.name.replace("-", "_") }}': {{ opt.name.replace('-', '_') }},
                {%- endfor %}
            }
            hooks.on_{{ command.name.replace("-", "_") }}(ctx=ctx, **kwargs)
        else:
            logger.error(f"Hook 'on_{{ command.name.replace("-", "_") }}' not implemented in cli_hooks.py")
            sys.exit(1)
    except Exception as e:
        handle_error(e, ctx.verbose)
  {% endfor %}
{%- endif %}

# ============================================================================
# INTERACTIVE MODE (if enabled)
# ============================================================================

{%- if cli.features and cli.features.interactive_mode and cli.features.interactive_mode.enabled %}

@cli.command('interactive')
@click.pass_obj
def interactive_mode(ctx):
    """Run in interactive mode."""
    logger.info("Entering interactive mode. Type 'help' for commands, 'exit' to quit.")
    
    commands = [
        {%- if cli.commands %}
          {%- for cmd_name in cli.commands.keys() %}
        '{{ cmd_name }}',
          {%- endfor %}
        {%- elif cli.root_command and cli.root_command.subcommands %}
          {%- for command in cli.root_command.subcommands %}
        '{{ command.name }}',
          {%- endfor %}
        {%- endif %}
        'help', 'exit'
    ]
    completer = WordCompleter(commands)
    
    while True:
        try:
            user_input = prompt('> ', completer=completer)
            
            if user_input.lower() == 'exit':
                logger.info("Exiting interactive mode.")
                break
            elif user_input.lower() == 'help':
                print("Available commands:")
                for cmd in commands:
                    if cmd not in ['help', 'exit']:
                        print(f"  - {cmd}")
            else:
                # Parse and execute command
                parts = user_input.split()
                if parts and parts[0] in commands:
                    # Invoke the Click command programmatically
                    try:
                        cli.main(parts, standalone_mode=False, obj=ctx)
                    except SystemExit:
                        pass  # Ignore exit in interactive mode
                else:
                    logger.warning(f"Unknown command: {user_input}")
                    
        except KeyboardInterrupt:
            logger.info("\nExiting interactive mode.")
            break
        except Exception as e:
            logger.error(f"Error: {e}")
{%- endif %}

# ============================================================================
# MAIN ENTRY POINT
# ============================================================================

def main():
    """Main entry point for the CLI."""
    import sys
    
    # Add spacing before command output (except when output is redirected)
    if sys.stdout.isatty():
        print()  # Empty line before
    
    try:
        cli(prog_name='{{ cli.name | default(project.command_name) }}')
    except Exception as e:
        handle_error(e, '--verbose' in sys.argv or '--debug' in sys.argv)
    finally:
        # Add spacing after command output (except when output is redirected)
        if sys.stdout.isatty():
            print()  # Empty line after

if __name__ == '__main__':
    main()