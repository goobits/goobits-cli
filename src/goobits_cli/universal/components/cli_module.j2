{# Universal CLI Module Template
   
   This template generates CLI module files that contain
   the main CLI structure and command definitions.
   
   Variables expected:
   - language: Target language (should be 'rust')
   - project: Project metadata
   - cli: CLI schema with commands
#}

{%- if language == 'rust' -%}
//! ╔══════════════════════════════════════════════════════════════════════════╗
//! ║                        AUTO-GENERATED FILE                               ║
//! ║  Generated by: goobits-cli v{{ project.version or '3.0.0' }}             ║
//! ║  ⚠️  DO NOT EDIT - Changes will be overwritten                           ║
//! ╚══════════════════════════════════════════════════════════════════════════╝
//!
//! CLI module for {{ project.display_name | default(project.package_name) }}
//! This module contains the CLI command structure and argument parsing logic.

use clap::{Arg, Command, ArgMatches, value_parser};
use anyhow::Result;
use crate::hooks::HookManager;
use crate::errors::{CliError, ExitCode};

/// Build the main CLI application
pub fn build_cli() -> Command {
    Command::new("{{ project.command_name }}")
        .version(crate::VERSION)
        .about("{{ cli.tagline | default(project.description | default(cli.description)) }}")
        .author("{{ project.author | default('Generated by Goobits CLI Framework') }}")
        {% if cli.commands -%}
        {%- for command_name, command in cli.commands.items() %}
        .subcommand(
            Command::new("{{ command_name }}")
                .about("{{ command.desc | default('No description provided') }}")
                {%- if command.args %}
                {%- for arg in command.args %}
                .arg(
                    Arg::new("{{ arg.name }}")
                        .help("{{ arg.desc | default('No description provided') }}")
                        {% if arg.required -%}
                        .required(true)
                        {%- else -%}
                        .required(false)
                        {%- endif %}
                        {%- if arg.multiple %}
                        .num_args(1..)
                        {%- endif %}
                        {%- if arg.choices %}
                        .value_parser({{ arg.choices | map('tojson') | join(', ') }})
                        {%- endif %}
                )
                {%- endfor %}
                {%- endif %}
                {%- if command.options %}
                {%- for option in command.options %}
                .arg(
                    Arg::new("{{ option.name }}")
                        .long("{{ option.name }}")
                        {% if option.short is defined and option.short and option.short != 'None' -%}
                        .short('{{ option.short }}')
                        {%- endif %}
                        .help("{{ option.desc | default('No description provided') }}")
                        {%- if option.type == 'flag' or option.type == 'bool' %}
                        .action(clap::ArgAction::SetTrue)
                        {%- elif option.type == 'int' %}
                        .value_parser(value_parser!(i32))
                        {%- elif option.type == 'float' %}
                        .value_parser(value_parser!(f64))
                        {%- else %}
                        .value_parser(clap::value_parser!(String))
                        {%- endif %}
                        {%- if option.default and option.type != 'flag' and option.type != 'bool' %}
                        .default_value("{{ option.default }}")
                        {%- endif %}
                        {%- if option.multiple %}
                        .num_args(1..)
                        {%- endif %}
                        {%- if option.choices %}
                        .value_parser({{ option.choices | map('tojson') | join(', ') }})
                        {%- endif %}
                )
                {%- endfor %}
                {%- endif %}
        )
        {%- endfor %}
        {%- endif %}
        .arg(
            Arg::new("verbose")
                .long("verbose")
                .short('v')
                .help("Enable verbose output")
                .action(clap::ArgAction::SetTrue)
        )
}

/// Execute a CLI command using the hook system
pub fn execute_command(matches: &ArgMatches, hook_manager: &HookManager) -> Result<()> {
    match matches.subcommand() {
        {% if cli.commands -%}
        {%- for command_name, command in cli.commands.items() %}
        Some(("{{ command_name }}", sub_matches)) => {
            let hook_name = "on_{{ command_name | replace('-', '_') }}";
            hook_manager.execute_hook(hook_name, sub_matches)
                .map_err(|e| CliError::new(format!("Failed to execute {}: {}", hook_name, e), ExitCode::GeneralError))?;
        }
        {%- endfor %}
        {%- endif %}
        _ => {
            println!("No command specified. Use --help for available commands.");
        }
    }
    
    Ok(())
}

{%- elif language == 'nodejs' -%}
/**
 * CLI module for {{ project.display_name | default(project.package_name) }}
 * 
 * This module contains the CLI command structure using Commander.js
 */

const { Command } = require('commander');
const { HookManager } = require('./hooks');

/**
 * Build the main CLI application
 * @returns {Command} The configured commander program
 */
function buildCli() {
    const program = new Command();
    
    program
        .name('{{ project.command_name }}')
        .version(require('../package.json').version)
        .description('{{ cli.tagline | default(cli.description | default(project.description)) }}');

    {% if cli.commands -%}
    {%- for command_name, command in cli.commands.items() %}
    program
        .command('{{ command_name }}')
        .description('{{ command.desc | default('No description provided') }}')
        {%- if command.args %}
        {%- for arg in command.args %}
        {% if arg.required -%}
        .argument('<{{ arg.name }}>', '{{ arg.desc | default('No description provided') }}')
        {%- else -%}
        .argument('[{{ arg.name }}]', '{{ arg.desc | default('No description provided') }}')
        {%- endif %}
        {%- endfor %}
        {%- endif %}
        {%- if command.options %}
        {%- for option in command.options %}
        {% if option.type == 'flag' or option.type == 'bool' -%}
        .option('{% if option.short %}-{{ option.short }}, {% endif %}--{{ option.name }}', '{{ option.desc | default('No description provided') }}')
        {%- else -%}
        .option('{% if option.short %}-{{ option.short }}, {% endif %}--{{ option.name }} <value>', '{{ option.desc | default('No description provided') }}'{% if option.default %}, '{{ option.default }}'{% endif %})
        {%- endif %}
        {%- endfor %}
        {%- endif %}
        .action(async ({% if command.args %}{{ command.args | map(attribute='name') | join(', ') }}{% if command.options %}, {% endif %}{% endif %}{% if command.options %}options{% endif %}) => {
            const hookManager = new HookManager();
            await hookManager.executeHook('on{{ command_name | title | replace('-', '') }}', {% if command.args %}{{ command.args | map(attribute='name') | join(', ') }}{% if command.options %}, {% endif %}{% endif %}{% if command.options %}options{% endif %});
        });
    {%- endfor %}
    {%- endif %}

    return program;
}

module.exports = {
    buildCli
};

{%- elif language == 'typescript' -%}
/**
 * CLI module for {{ project.display_name | default(project.package_name) }}
 * 
 * This module contains the CLI command structure using Commander.js with TypeScript
 */

import { Command } from 'commander';
import { HookManager } from './hooks';

/**
 * Build the main CLI application
 * @returns The configured commander program
 */
export function buildCli(): Command {
    const program = new Command();
    
    program
        .name('{{ project.command_name }}')
        .version(require('../package.json').version)
        .description('{{ cli.tagline | default(cli.description | default(project.description)) }}');

    {% if cli.commands -%}
    {%- for command_name, command in cli.commands.items() %}
    program
        .command('{{ command_name }}')
        .description('{{ command.desc | default('No description provided') }}')
        {%- if command.args %}
        {%- for arg in command.args %}
        {% if arg.required -%}
        .argument('<{{ arg.name }}>', '{{ arg.desc | default('No description provided') }}')
        {%- else -%}
        .argument('[{{ arg.name }}]', '{{ arg.desc | default('No description provided') }}')
        {%- endif %}
        {%- endfor %}
        {%- endif %}
        {%- if command.options %}
        {%- for option in command.options %}
        {% if option.type == 'flag' or option.type == 'bool' -%}
        .option('{% if option.short %}-{{ option.short }}, {% endif %}--{{ option.name }}', '{{ option.desc | default('No description provided') }}')
        {%- else -%}
        .option('{% if option.short %}-{{ option.short }}, {% endif %}--{{ option.name }} <value>', '{{ option.desc | default('No description provided') }}'{% if option.default %}, '{{ option.default }}'{% endif %})
        {%- endif %}
        {%- endfor %}
        {%- endif %}
        .action(async ({% if command.args %}{{ command.args | map(attribute='name') | join(': string, ') }}{% if command.options %}: string, {% endif %}{% endif %}{% if command.options %}options: any{% endif %}) => {
            const hookManager = new HookManager();
            await hookManager.executeHook('on{{ command_name | title | replace('-', '') }}', {% if command.args %}{{ command.args | map(attribute='name') | join(', ') }}{% if command.options %}, {% endif %}{% endif %}{% if command.options %}options{% endif %});
        });
    {%- endfor %}
    {%- endif %}

    return program;
}

{%- elif language == 'python' -%}
"""CLI module for {{ project.display_name | default(project.package_name) }}

This module contains the CLI command structure using Click.
"""

import click
from typing import Optional, List
from .hooks import HookManager
from .errors import CliError

# Initialize hook manager
hook_manager = HookManager()

@click.group()
@click.version_option(version='{{ project.version | default('0.1.0') }}')
@click.option('--verbose', '-v', is_flag=True, help='Enable verbose output')
@click.pass_context
def cli(ctx, verbose):
    """{{ project.description | default(cli.description | default(cli.tagline)) }}"""
    ctx.ensure_object(dict)
    ctx.obj['verbose'] = verbose

{% if cli.commands -%}
{%- for command_name, command in cli.commands.items() %}
@cli.command('{{ command_name }}')
{%- if command.args %}
{%- for arg in command.args %}
@click.argument('{{ arg.name | upper }}'{% if not arg.required %}, required=False{% endif %}{% if arg.multiple %}, nargs=-1{% endif %})
{%- endfor %}
{%- endif %}
{%- if command.options %}
{%- for option in command.options %}
{%- if option.type == 'flag' or option.type == 'bool' %}
@click.option('--{{ option.name }}'{% if option.short %}, '-{{ option.short }}'{% endif %}, is_flag=True, help='{{ option.desc | default('No description provided') }}')
{%- elif option.type == 'int' %}
@click.option('--{{ option.name }}'{% if option.short %}, '-{{ option.short }}'{% endif %}, type=int{% if option.default %}, default={{ option.default }}{% endif %}, help='{{ option.desc | default('No description provided') }}')
{%- elif option.type == 'float' %}
@click.option('--{{ option.name }}'{% if option.short %}, '-{{ option.short }}'{% endif %}, type=float{% if option.default %}, default={{ option.default }}{% endif %}, help='{{ option.desc | default('No description provided') }}')
{%- else %}
@click.option('--{{ option.name }}'{% if option.short %}, '-{{ option.short }}'{% endif %}{% if option.default %}, default='{{ option.default }}'{% endif %}, help='{{ option.desc | default('No description provided') }}')
{%- endif %}
{%- endfor %}
{%- endif %}
@click.pass_context
def {{ command_name | replace('-', '_') }}(ctx{% if command.args %}, {{ command.args | map(attribute='name') | map('lower') | join(', ') }}{% endif %}{% if command.options %}, {{ command.options | map(attribute='name') | map('replace', '-', '_') | join(', ') }}{% endif %}):
    """{{ command.desc | default('No description provided') }}"""
    try:
        hook_manager.execute_hook('on_{{ command_name | replace('-', '_') }}'{% if command.args %}, {{ command.args | map(attribute='name') | map('lower') | join(', ') }}{% endif %}{% if command.options %}{% for option in command.options %}, {{ option.name | replace('-', '_') }}={{ option.name | replace('-', '_') }}{% endfor %}{% endif %})
    except Exception as e:
        if ctx.obj.get('verbose'):
            raise
        else:
            raise CliError(f"Command failed: {e}")

{%- endfor %}
{%- endif %}

if __name__ == '__main__':
    cli()

{%- else -%}
// CLI module not applicable for {{ language }}
{%- endif -%}