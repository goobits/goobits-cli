#!/usr/bin/env python3
"""
Debug script to check what files are actually generated by the universal template system.
"""

import os
import sys
import tempfile
import subprocess
import yaml
from pathlib import Path

# Add the source directory to path
sys.path.insert(0, '/workspace/src')

def debug_python_multi_file_generation():
    """Debug Python CLI generation to see what files are created."""
    print("=== Debugging Python Multi-File Generation ===")
    
    with tempfile.TemporaryDirectory() as temp_dir:
        config = {
            'package_name': 'test-multi-file',
            'command_name': 'testmulti', 
            'display_name': 'Test Multi File',
            'description': 'Test multi-file generation',
            'language': 'python',
            'cli_output_path': f'{temp_dir}/cli.py',  # This might affect where files go
            
            'python': {
                'minimum_version': '3.8',
                'maximum_version': '3.13'
            },
            
            'installation': {
                'pypi_name': 'test-multi-file'
            },
            
            'shell_integration': {
                'enabled': False,
                'alias': 'testmulti'
            },
            
            'validation': {
                'check_api_keys': False,
                'check_disk_space': False
            },
            
            'cli': {
                'name': 'testmulti',
                'tagline': 'Test multi-file CLI',
                'description': 'Test multi-file CLI generation',
                'commands': {
                    'hello': {
                        'desc': 'Say hello',
                        'args': [{
                            'name': 'name',
                            'desc': 'Name to greet',
                            'type': 'string',
                            'required': True
                        }]
                    }
                }
            }
        }
        
        config_file = os.path.join(temp_dir, 'goobits.yaml')
        with open(config_file, 'w') as f:
            yaml.dump(config, f)
        
        # Generate CLI
        print(f"Generating CLI in: {temp_dir}")
        build_cmd = [sys.executable, '-m', 'goobits_cli.main', 'build', config_file]
        result = subprocess.run(build_cmd, cwd=temp_dir, capture_output=True, text=True)
        
        if result.returncode != 0:
            print(f"Build failed: {result.stderr}")
            return
        
        print(f"Build successful!")
        print(f"Build stdout: {result.stdout}")
        
        # List all files created
        print("\nFiles created:")
        for root, dirs, files in os.walk(temp_dir):
            for file in files:
                file_path = os.path.join(root, file)
                relative_path = os.path.relpath(file_path, temp_dir)
                file_size = os.path.getsize(file_path)
                print(f"  {relative_path} ({file_size} bytes)")
        
        # Examine specific files
        expected_files = [
            'cli.py',
            'src/test_multi_file/cli.py',
            'src/test_multi_file/logger.py',
            'src/test_multi_file/__init__.py',
            'pyproject.toml'
        ]
        
        print("\nChecking expected files:")
        for expected_file in expected_files:
            file_path = os.path.join(temp_dir, expected_file)
            if os.path.exists(file_path):
                with open(file_path, 'r') as f:
                    content = f.read()
                
                print(f"  ✓ {expected_file} exists ({len(content)} chars)")
                
                # If it's a logger file, check for logging content
                if 'logger' in expected_file.lower():
                    logging_indicators = [
                        'setup_logging', 'get_logger', 'StructuredFormatter',
                        'contextvars', 'ContextVar', 'json.dumps'
                    ]
                    
                    found_indicators = [ind for ind in logging_indicators if ind in content]
                    if found_indicators:
                        print(f"    Logger indicators: {found_indicators}")
                    else:
                        print("    No logger indicators found")
                        
                    # Show first few lines
                    lines = content.split('\n')
                    print("    First 10 lines:")
                    for i, line in enumerate(lines[:10]):
                        print(f"      {i+1}: {line}")
                
                # If it's the main CLI file, check for logger imports
                elif 'cli.py' in expected_file:
                    if 'import logger' in content or 'from .logger' in content or 'from logger' in content:
                        print("    ✓ CLI file imports logger")
                    else:
                        print("    ✗ CLI file does NOT import logger")
                        
                    # Check for logging setup calls
                    if 'setup_logging' in content or 'get_logger' in content:
                        print("    ✓ CLI file uses logging functions")
                    else:
                        print("    ✗ CLI file does NOT use logging functions")
                        
            else:
                print(f"  ✗ {expected_file} does NOT exist")

def test_universal_directly():
    """Test universal template engine directly."""
    print("\n=== Testing Universal Template Engine Directly ===")
    
    try:
        from goobits_cli.universal.template_engine import UniversalTemplateEngine
        from goobits_cli.schemas import GoobitsConfigSchema
        
        # Create minimal config
        config_dict = {
            'package_name': 'test-direct',
            'command_name': 'testdirect',
            'display_name': 'Test Direct',
            'description': 'Test direct generation',
            
            'python': {
                'minimum_version': '3.8',
                'maximum_version': '3.13'
            },
            
            'installation': {
                'pypi_name': 'test-direct'
            },
            
            'shell_integration': {
                'enabled': False,
                'alias': 'testdirect'
            },
            
            'validation': {
                'check_api_keys': False,
                'check_disk_space': False
            },
            
            'cli': {
                'name': 'testdirect',
                'tagline': 'Test direct CLI',
                'description': 'Test direct CLI generation',
                'commands': {
                    'hello': {
                        'desc': 'Say hello',
                        'args': [{
                            'name': 'name',
                            'desc': 'Name to greet',
                            'type': 'string',
                            'required': True
                        }]
                    }
                }
            }
        }
        
        config = GoobitsConfigSchema(**config_dict)
        
        # Generate with universal engine
        engine = UniversalTemplateEngine()
        
        with tempfile.TemporaryDirectory() as temp_dir:
            output_dir = Path(temp_dir)
            
            try:
                generated_files = engine.generate_cli(config, "python", output_dir)
                
                print(f"✓ Universal engine generated {len(generated_files)} files:")
                
                for file_path, content in generated_files.items():
                    print(f"  {file_path} ({len(content)} chars)")
                    
                    # Check logger file specifically
                    if 'logger' in file_path.lower():
                        logging_indicators = [
                            'setup_logging', 'get_logger', 'StructuredFormatter',
                            'contextvars', 'ContextVar', 'json.dumps'
                        ]
                        
                        found_indicators = [ind for ind in logging_indicators if ind in content]
                        if found_indicators:
                            print(f"    Logger indicators: {found_indicators}")
                        else:
                            print("    No logger indicators found")
                            
                            # Show sample if no indicators
                            print("    Sample content (first 500 chars):")
                            print("    " + content[:500].replace('\n', '\n    '))
                
                return True
                
            except Exception as e:
                print(f"✗ Universal engine generation failed: {e}")
                import traceback
                traceback.print_exc()
                return False
        
    except Exception as e:
        print(f"✗ Universal engine test failed: {e}")
        return False

def main():
    """Run debugging tests."""
    debug_python_multi_file_generation()
    test_universal_directly()

if __name__ == "__main__":
    main()